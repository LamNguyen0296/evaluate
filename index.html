<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluate</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="overlay"></div>
  <div id="socket-status" class="socket-status"></div>
  <div id="app" class="page"></div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    (function () {
      const app = document.getElementById('app');
      const params = new URLSearchParams(window.location.search);
      window.isEvaluationMode = false;

      function row(labelNode, inputNode) {
        const line = document.createElement('div');
        line.className = 'form-row';
        const lbl = document.createElement('div');
        lbl.className = 'label';
        lbl.appendChild(labelNode);
        const field = document.createElement('div');
        field.className = 'field';
        field.appendChild(inputNode);
        line.appendChild(lbl);
        line.appendChild(field);
        return line;
      }

      function createCard(titleText) {
        const card = document.createElement('div');
        card.className = 'card';
        const header = document.createElement('div');
        header.className = 'card__header';
        const h = document.createElement('h2');
        h.className = 'card__title';
        h.textContent = titleText;
        header.appendChild(h);
        const body = document.createElement('div');
        body.className = 'card__body';
        card.appendChild(header);
        card.appendChild(body);
        return { card, body };
      }

      function createCardNoHeader() {
        const card = document.createElement('div');
        card.className = 'card';
        const body = document.createElement('div');
        body.className = 'card__body';
        card.appendChild(body);
        return { card, body };
      }

      async function fetchMembers() {
        const res = await fetch('/api/members?rule=member', { cache: 'no-store' });
        if (!res.ok) throw new Error('T·∫£i nh√≥m th·∫•t b·∫°i');
        return await res.json();
      }

      function renderForm() {
        app.innerHTML = '';
        const { card, body } = createCard('Tham gia ƒë√°nh gi√°');
        const form = document.createElement('form');

        // Row 1: radio role
        const radiosWrap = document.createElement('div');
        radiosWrap.className = 'radio-group';
        const roles = [
          { value: 'admin', label: 'Ch·ªß ph√≤ng' },
          { value: 'member', label: 'Nh√≥m' },
          { value: 'visitor', label: 'Th·∫ßy/C√¥' },
        ];
        roles.forEach(r => {
          const id = 'role-' + r.value;
          const label = document.createElement('label');
          label.className = 'radio';
          label.htmlFor = id;
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'role';
          input.value = r.value;
          input.id = id;
          label.appendChild(input);
          const span = document.createElement('span');
          span.textContent = ' ' + r.label;
          label.appendChild(span);
          radiosWrap.appendChild(label);
        });
        form.appendChild(row(document.createTextNode('Quy·ªÅn'), radiosWrap));

        // Row 2: select group (only for member)
        const groupSelect = document.createElement('select');
        groupSelect.name = 'groupKey';
        groupSelect.className = 'select';
        const groupRow = row(document.createTextNode('Ch·ªçn nh√≥m'), groupSelect);
        groupRow.style.display = 'none';
        form.appendChild(groupRow);

        // Row 3: name (hidden for admin)
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.name = 'name';
        nameInput.placeholder = 'T√™n hi·ªÉn th·ªã';
        nameInput.className = 'input';
        const nameRow = row(document.createTextNode('T√™n'), nameInput);
        nameRow.style.display = 'none';
        form.appendChild(nameRow);

        // Row 4: submit
        const submit = document.createElement('button');
        submit.type = 'submit';
        submit.textContent = 'Tham gia';
        submit.className = 'button';
        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.appendChild(submit);
        form.appendChild(row(document.createTextNode(''), actions));

        // Role change effects
        form.addEventListener('change', async (e) => {
          if (e.target && e.target.name === 'role') {
            const role = e.target.value;
            if (role === 'member') {
              nameRow.style.display = '';
              groupRow.style.display = '';
              // load groups
              try {
                const groups = await fetchMembers();
                groupSelect.innerHTML = '<option value="">-- Ch·ªçn nh√≥m --</option>';
                groups.forEach(g => {
                  const opt = document.createElement('option');
                  opt.value = g.key;
                  opt.textContent = g.key.toUpperCase();
                  groupSelect.appendChild(opt);
                });
              } catch (err) {
                alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch nh√≥m');
              }
            } else if (role === 'visitor') {
              groupRow.style.display = 'none';
              nameRow.style.display = '';
            } else {
              groupRow.style.display = 'none';
              nameRow.style.display = 'none';
            }
          }
        });

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(form);
          const role = (fd.get('role') || '').toString();
          const groupKey = (fd.get('groupKey') || '').toString();
          const name = (fd.get('name') || '').toString().trim();
          if (!role) return alert('Vui l√≤ng ch·ªçn quy·ªÅn');
          if (role === 'member' && !groupKey) return alert('Vui l√≤ng ch·ªçn nh√≥m');
          if ((role === 'member' || role === 'visitor') && !name) return alert('Vui l√≤ng nh·∫≠p t√™n');
          try {
            const res = await fetch('/api/join', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ role, groupKey, name })
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || 'Tham gia th·∫•t b·∫°i');
              return;
            }
            const next = new URL(window.location.href);
            next.searchParams.set('key', data.key);
            next.searchParams.set('role', data.role);
            if (data.name) next.searchParams.set('name', data.name); else next.searchParams.delete('name');
            window.location.replace(next.toString());
          } catch (err) {
            alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i');
          }
        });

        body.appendChild(form);
        app.appendChild(card);
      }

      async function renderSummary() {
        app.innerHTML = '';
        const role = params.get('role') || '‚Äî';
        const key = params.get('key') || '‚Äî';
        const name = params.get('name') || '';

        if (role === 'admin') {
          await renderAdminDashboard();
        } else if (role === 'member') {
          await renderMemberDashboard(key);
        } else if (role === 'visitor') {
          await renderVisitorDashboard(key, name);
        } else {
          const { card, body } = createCard('Th√¥ng tin truy c·∫≠p');
          const wrap = document.createElement('div');
          wrap.className = 'summary';
          const p1 = document.createElement('p');
          p1.textContent = `Rule: ${role}`;
          const p2 = document.createElement('p');
          p2.textContent = `Account key: ${key}`;
          wrap.appendChild(p1);
          wrap.appendChild(p2);
          const back = document.createElement('button');
          back.textContent = 'ƒê·ªïi l·ª±a ch·ªçn';
          back.className = 'button';
          back.addEventListener('click', () => {
            const url = new URL(window.location.href);
            url.search = '';
            window.location.replace(url.toString());
          });
          body.appendChild(wrap);
          body.appendChild(back);
          app.appendChild(card);
        }
      }

      async function renderMemberDashboard(key) {
        try {
          const [memberRes, roomCritRes, memberCritRes] = await Promise.all([
            fetch(`/api/member/${key}`, { cache: 'no-store' }),
            fetch('/api/criteria/roomCriteria', { cache: 'no-store' }),
            fetch('/api/criteria/memberCriteria', { cache: 'no-store' })
          ]);
          if (!memberRes.ok) throw new Error('Failed to load member data');
          const member = await memberRes.json();
          const roomCrit = await roomCritRes.json();
          const memCrit = await memberCritRes.json();

          const ratingLevels = (roomCrit.ratingLevels && roomCrit.ratingLevels.length)
            ? roomCrit.ratingLevels
            : (memCrit.ratingLevels || []);

          function sumMaxScore(criteria) {
            return (criteria || []).reduce((s, c) => s + (c.maxScore || 0), 0);
          }

          function getExpectedScoreForLevel(levelId, maxScore) {
            const percentage = [0, 0.25, 0.5, 0.75, 1.0];
            return Math.round(maxScore * percentage[levelId] * 100) / 100;
          }

          function inferLevelByScore(score, maxScore) {
            if (!maxScore || score <= 0) return null;
            let best = { level: null, diff: Infinity };
            ratingLevels.forEach(lvl => {
              const expected = getExpectedScoreForLevel(lvl.id, maxScore);
              const diff = Math.abs((score || 0) - expected);
              if (diff < best.diff) best = { level: lvl, diff };
            });
            return best.level;
          }

          // Helper function to render rating levels as buttons
          function renderRatingLevels(criterion, selectedLevel, score, maxScore) {
            const container = document.createElement('div');
            container.className = 'detail-criterion-row';
            
            const criterionName = document.createElement('div');
            criterionName.className = 'detail-criterion-name';
            criterionName.textContent = criterion.name || ('Ti√™u ch√≠ ' + criterion.id);
            container.appendChild(criterionName);
            
            const scoreText = document.createElement('div');
            scoreText.className = 'detail-criterion-score';
            if (score > 0) {
              scoreText.appendChild(document.createTextNode('('));
              const scoreSpan = document.createElement('span');
              scoreSpan.style.fontWeight = 'bold';
              scoreSpan.style.color = '#ef4444';
              scoreSpan.textContent = score;
              scoreText.appendChild(scoreSpan);
              scoreText.appendChild(document.createTextNode(`/${maxScore})`));
            } else {
              scoreText.textContent = 'Ch∆∞a ƒë√°nh gi√°';
            }
            container.appendChild(scoreText);
            
            const levelsContainer = document.createElement('div');
            levelsContainer.className = 'detail-rating-levels';
            
            // Sort rating levels in descending order (4, 3, 2, 1)
            const sortedLevels = [...ratingLevels].sort((a, b) => b.id - a.id);
            
            sortedLevels.forEach(level => {
              const levelBtn = document.createElement('div');
              levelBtn.className = 'detail-rating-btn';
              
              const isSelected = selectedLevel && selectedLevel.id === level.id;
              if (isSelected) {
                levelBtn.classList.add('detail-rating-btn-selected');
              }
              
              const emoji = document.createElement('span');
              emoji.className = 'detail-rating-emoji';
              emoji.textContent = level.emoji || '';
              
              const text = document.createElement('span');
              text.className = 'detail-rating-text';
              text.textContent = level.name || '';
              
              levelBtn.appendChild(emoji);
              levelBtn.appendChild(text);
              levelsContainer.appendChild(levelBtn);
            });
            
            container.appendChild(levelsContainer);
            
            return container;
          }

          const { card, body } = createCardNoHeader();
          
          // Header row: Avatar + Key + Name + Score (1 line)
          const headerRow = document.createElement('div');
          headerRow.className = 'member-header-row';
          
          const avatar = document.createElement('div');
          avatar.className = 'member-avatar';
          avatar.textContent = member.avatar || 'üë§';
          
          const keyDiv = document.createElement('div');
          keyDiv.className = 'member-key';
          keyDiv.textContent = member.key.toUpperCase();
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'member-name';
          nameDiv.textContent = member.name || 'Ch∆∞a c√≥ t√™n';
          
          const scoreDiv = document.createElement('div');
          scoreDiv.className = 'member-score-header';
          const scoreIcon = document.createElement('span');
          scoreIcon.className = 'score-icon';
          scoreIcon.textContent = '‚≠ê';
          const scoreValue = document.createElement('span');
          scoreValue.textContent = member.score || 0;
          scoreDiv.appendChild(scoreIcon);
          scoreDiv.appendChild(scoreValue);
          
          headerRow.appendChild(avatar);
          headerRow.appendChild(keyDiv);
          headerRow.appendChild(nameDiv);
          headerRow.appendChild(scoreDiv);
          
          const infoSection = document.createElement('div');
          infoSection.className = 'member-info-section';
          
          // N√∫t ƒê√°nh gi√° cho member (di chuy·ªÉn l√™n tr√™n)
          const actionRow = document.createElement('div');
          actionRow.className = 'dashboard-actions';
          actionRow.style.marginBottom = '24px';
          const evalBtn = document.createElement('button');
          evalBtn.className = 'button button-action button-evaluate';
          const evalIcon = document.createElement('span');
          evalIcon.className = 'button-icon';
          evalIcon.innerHTML = '‚≠ê';
          const evalText = document.createElement('span');
          evalText.textContent = 'ƒê√°nh gi√°';
          evalBtn.appendChild(evalIcon);
          evalBtn.appendChild(evalText);
          evalBtn.addEventListener('click', () => {
            window.isEvaluationMode = true;
            if (typeof window.renderEvaluationForm === 'function') {
              window.renderEvaluationForm();
            }
          });
          actionRow.appendChild(evalBtn);
          
          // ƒêi·ªÉm t·ª´ng ph·∫ßn - hi·ªÉn th·ªã breakdown gi·ªëng admin
          const detailSection = document.createElement('div');
          detailSection.className = 'member-detail-section';
          const detailTitle = document.createElement('h3');
          detailTitle.textContent = 'ƒêi·ªÉm t·ª´ng ph·∫ßn';
          detailSection.appendChild(detailTitle);

          // Total current score
          const totalBox = document.createElement('div');
          totalBox.className = 'detail-total-box';
          totalBox.innerHTML = `<strong>T·ªïng ƒëi·ªÉm hi·ªán c√≥:</strong> <span class="detail-total-score">${member.score || 0}</span>`;
          detailSection.appendChild(totalBox);

          // Section: ƒêi·ªÉm ch·ªß ph√≤ng
          const adminSection = document.createElement('div');
          adminSection.className = 'detail-section';
          const adminTitle = document.createElement('h4');
          const roomMax = sumMaxScore(roomCrit.criteria);
          const roomScore = (member.detail_score && member.detail_score.room && member.detail_score.room.score) || 0;
          adminTitle.textContent = `ƒêi·ªÉm ch·ªß ph√≤ng (${roomScore}/${roomMax})`;
          adminSection.appendChild(adminTitle);
          const adminList = document.createElement('div');
          adminList.className = 'detail-list';
          (roomCrit.criteria || []).forEach(c => {
            const item = (member.detail_score && member.detail_score.room && member.detail_score.room.criteria || []).find(x => x.id === c.id);
            const score = item ? item.score : 0;
            const selectedLevel = item ? inferLevelByScore(item.score, c.maxScore) : null;
            const criterionRow = renderRatingLevels(c, selectedLevel, score, c.maxScore);
            adminList.appendChild(criterionRow);
          });
          adminSection.appendChild(adminList);
          detailSection.appendChild(adminSection);

          // Section: Avg ƒëi·ªÉm c√°c nh√≥m
          (async () => {
            const memberMax = sumMaxScore(memCrit.criteria);
            const otherMembers = (await (await fetch('/api/admin/members', { cache: 'no-store' })).json()).map(m => m.key).filter(k => k !== member.key);
            const perMemberScores = [];
            const memberSection = document.createElement('div');
            memberSection.className = 'detail-section';
            const memberList = document.createElement('div');
            memberList.className = 'detail-list';
            otherMembers.forEach(k => {
              const entry = member.detail_score && member.detail_score[k];
              const sc = entry && typeof entry.score === 'number' ? entry.score : 0;
              perMemberScores.push(sc);
              
              // Member header
              const memberHeader = document.createElement('div');
              memberHeader.className = 'detail-member-header';
              memberHeader.textContent = `ƒêi·ªÉm ${k.toUpperCase()} (${sc}/${memberMax})`;
              memberList.appendChild(memberHeader);
              
              // criteria breakdown under each
              const sub = document.createElement('div');
              sub.className = 'detail-sublist';
              (memCrit.criteria || []).forEach(c => {
                const found = entry && entry.criteria ? entry.criteria.find(x => x.id === c.id) : null;
                const score = found ? found.score : 0;
                const selectedLevel = found ? inferLevelByScore(found.score, c.maxScore) : null;
                const criterionRow = renderRatingLevels(c, selectedLevel, score, c.maxScore);
                sub.appendChild(criterionRow);
              });
              memberList.appendChild(sub);
            });
            const memberAvg = perMemberScores.length ? Math.round((perMemberScores.reduce((a,b)=>a+b,0)/perMemberScores.length)*100)/100 : 0;
            const memberTitle = document.createElement('h4');
            memberTitle.textContent = `Trung b√¨nh ƒëi·ªÉm c√°c nh√≥m (${memberAvg}/${memberMax})`;
            memberSection.appendChild(memberTitle);
            memberSection.appendChild(memberList);
            detailSection.appendChild(memberSection);

            // Section: Visitor
            const visitorSection = document.createElement('div');
            visitorSection.className = 'detail-section';
            const visitorsRes = await fetch('/api/members?rule=visitor', { cache: 'no-store' });
            const visitors = visitorsRes.ok ? await visitorsRes.json() : [];
            const visitorList = document.createElement('div');
            visitorList.className = 'detail-list';
            const visitorScores = [];
            visitors.forEach(v => {
              const k = v.key;
              const entry = member.detail_score && member.detail_score[k];
              const sc = entry && typeof entry.score === 'number' ? entry.score : 0;
              if (sc > 0) {
                visitorScores.push(sc);
                
                // Visitor header
                const visitorHeader = document.createElement('div');
                visitorHeader.className = 'detail-member-header';
                visitorHeader.textContent = `ƒêi·ªÉm ${v.name || k} (${sc}/${memberMax})`;
                visitorList.appendChild(visitorHeader);
                
                // criteria breakdown under each
                const sub = document.createElement('div');
                sub.className = 'detail-sublist';
                (memCrit.criteria || []).forEach(c => {
                  const found = entry && entry.criteria ? entry.criteria.find(x => x.id === c.id) : null;
                  const score = found ? found.score : 0;
                  const selectedLevel = found ? inferLevelByScore(found.score, c.maxScore) : null;
                  const criterionRow = renderRatingLevels(c, selectedLevel, score, c.maxScore);
                  sub.appendChild(criterionRow);
                });
                visitorList.appendChild(sub);
              }
            });
            const visitorAvg = visitorScores.length ? Math.round((visitorScores.reduce((a,b)=>a+b,0)/visitorScores.length)*100)/100 : 0;
            const visitorTitle = document.createElement('h4');
            visitorTitle.textContent = `Trung b√¨nh ƒëi·ªÉm Th·∫ßy/C√¥ (${visitorAvg}/${memberMax})`;
            visitorSection.appendChild(visitorTitle);
            visitorSection.appendChild(visitorList);
            detailSection.appendChild(visitorSection);
          })();
          
          body.appendChild(headerRow);
          body.appendChild(infoSection);
          body.appendChild(actionRow);
          body.appendChild(detailSection);
          app.appendChild(card);
        } catch (err) {
          app.innerHTML = '<div class="card"><div class="card__body"><p style="color: #ef4444;">L·ªói t·∫£i th√¥ng tin: ' + err.message + '</p></div></div>';
        }
      }

      async function renderVisitorDashboard(key, name) {
        try {
          const container = document.createElement('div');
          container.className = 'visitor-dashboard';
          
          // Title: Th·∫ßy/c√¥ + t√™n
          const titleBox = document.createElement('div');
          titleBox.className = 'visitor-title-box';
          const title = document.createElement('h1');
          title.className = 'visitor-title';
          title.textContent = `Th·∫ßy/c√¥ ${name || 'Ch∆∞a c√≥ t√™n'}`;
          titleBox.appendChild(title);
          container.appendChild(titleBox);

          // Danh s√°ch nh√≥m
          const membersBlock = document.createElement('div');
          membersBlock.className = 'dashboard-block';
          const membersTitle = document.createElement('h2');
          membersTitle.textContent = 'Danh s√°ch nh√≥m';
          membersBlock.appendChild(membersTitle);
          const membersList = document.createElement('div');
          membersList.className = 'members-list';
          membersBlock.appendChild(membersList);
          container.appendChild(membersBlock);

          // N√∫t ƒê√°nh gi√° ·ªü d∆∞·ªõi c√πng, canh gi·ªØa
          const actionBlock = document.createElement('div');
          actionBlock.className = 'visitor-actions';
          const evalBtn = document.createElement('button');
          evalBtn.className = 'button button-action button-evaluate';
          const evalIcon = document.createElement('span');
          evalIcon.className = 'button-icon';
          evalIcon.innerHTML = '‚≠ê';
          const evalText = document.createElement('span');
          evalText.textContent = 'ƒê√°nh gi√°';
          evalBtn.appendChild(evalIcon);
          evalBtn.appendChild(evalText);
          evalBtn.addEventListener('click', () => {
            window.isEvaluationMode = true;
            if (typeof window.renderEvaluationForm === 'function') {
              window.renderEvaluationForm();
            }
          });
          actionBlock.appendChild(evalBtn);
          container.appendChild(actionBlock);

          app.appendChild(container);

          // Load danh s√°ch nh√≥m
          await loadAndRenderMembers(membersList);

          // Auto refresh
          let isRefreshing = false;
          setInterval(async () => {
            if (isRefreshing) return;
            isRefreshing = true;
            try {
              await loadAndRenderMembers(membersList);
            } finally {
              isRefreshing = false;
            }
          }, 5000);
        } catch (err) {
          app.innerHTML = '<div class="card"><div class="card__body"><p style="color: #ef4444;">L·ªói t·∫£i th√¥ng tin: ' + err.message + '</p></div></div>';
        }
      }

      window.renderEvaluationForm = async function renderEvaluationForm() {
        app.innerHTML = '';
        const key = params.get('key') || '';
        const role = params.get('role') || '';
        
        if (!key || !role) {
          app.innerHTML = '<div class="card"><div class="card__body"><p style="color: #ef4444;">Thi·∫øu th√¥ng tin ƒëƒÉng nh·∫≠p</p></div></div>';
          return;
        }

        try {
          const container = document.createElement('div');
          container.className = 'evaluation-container';
          
          const title = document.createElement('h1');
          title.className = 'evaluation-title';
          title.textContent = 'ƒê√°nh gi√°';
          const titleBox = document.createElement('div');
          titleBox.className = 'evaluation-title-box';
          titleBox.appendChild(title);
          container.appendChild(titleBox);

          // Track all evaluation cards and their state
          const evaluationCards = new Map();
          const allEvaluations = new Map(); // targetKey -> { scores: {...}, form: formElement }
          
          // Helper to check if member already evaluated
          function hasBeenEvaluated(memberDetail, evaluatorKey, evaluatorRole) {
            if (!memberDetail || !memberDetail.detail_score) return false;
            const storageKey = (evaluatorRole === 'admin') ? 'room' : evaluatorKey;
            const entry = memberDetail.detail_score[storageKey];
            return entry && typeof entry.score === 'number' && entry.score > 0;
          }

          if (role === 'admin') {
            // Admin ƒë√°nh gi√° 4 member
            const membersRes = await fetch('/api/members?rule=member');
            const members = await membersRes.json();
            
            // Get admin evaluation_key
            const adminRes = await fetch('/api/member/room');
            const admin = await adminRes.json();
            const criteriaRes = await fetch(`/api/criteria/${admin.evaluation_key || 'roomCriteria'}`);
            const criteriaData = await criteriaRes.json();

            // Fetch all member details to check evaluation status
            const memberDetailsPromises = members.map(m => 
              fetch(`/api/member/${m.key}`, { cache: 'no-store' }).then(r => r.ok ? r.json() : null).catch(() => null)
            );
            const memberDetails = await Promise.all(memberDetailsPromises);

            for (let i = 0; i < members.length; i++) {
              const member = members[i];
              const memberDetail = memberDetails[i];
              
              // Skip if already evaluated
              if (hasBeenEvaluated(memberDetail, key, role)) continue;
              
              const { card, form, scores } = createEvaluationCard(member, criteriaData.criteria, criteriaData.ratingLevels, key, role);
              container.appendChild(card);
              evaluationCards.set(member.key, { card, form, scores, member, criteriaCount: criteriaData.criteria.length });
              allEvaluations.set(member.key, { scores: {}, form });
            }
          } else if (role === 'member') {
            // Member ƒë√°nh gi√° 3 nh√≥m c√≤n l·∫°i
            const membersRes = await fetch('/api/members?rule=member');
            const allMembers = await membersRes.json();
            const otherMembers = allMembers.filter(m => m.key !== key);
            
            // Get member evaluation_key
            const currentMemberRes = await fetch(`/api/member/${key}`);
            const currentMember = await currentMemberRes.json();
            const criteriaRes = await fetch(`/api/criteria/${currentMember.evaluation_key || 'memberCriteria'}`);
            const criteriaData = await criteriaRes.json();

            // Fetch all member details to check evaluation status
            const memberDetailsPromises = otherMembers.map(m => 
              fetch(`/api/member/${m.key}`, { cache: 'no-store' }).then(r => r.ok ? r.json() : null).catch(() => null)
            );
            const memberDetails = await Promise.all(memberDetailsPromises);

            for (let i = 0; i < otherMembers.length; i++) {
              const member = otherMembers[i];
              const memberDetail = memberDetails[i];
              
              // Skip if already evaluated
              if (hasBeenEvaluated(memberDetail, key, role)) continue;
              
              const { card, form, scores } = createEvaluationCard(member, criteriaData.criteria, criteriaData.ratingLevels, key, role);
              container.appendChild(card);
              evaluationCards.set(member.key, { card, form, scores, member, criteriaCount: criteriaData.criteria.length });
              allEvaluations.set(member.key, { scores: {}, form });
            }
          } else if (role === 'visitor') {
            // Visitor ƒë√°nh gi√° 4 nh√≥m
            const membersRes = await fetch('/api/members?rule=member');
            const members = await membersRes.json();
            
            // Get visitor info to get evaluation_key
            const visitorRes = await fetch(`/api/member/${key}`, { cache: 'no-store' });
            const visitor = visitorRes.ok ? await visitorRes.json() : null;
            const evaluationKey = (visitor && visitor.evaluation_key) ? visitor.evaluation_key : 'memberCriteria';
            
            // Visitor d√πng evaluation_key t·ª´ member.json
            const criteriaRes = await fetch(`/api/criteria/${evaluationKey}`);
            const criteriaData = await criteriaRes.json();

            // Fetch all member details to check evaluation status
            const memberDetailsPromises = members.map(m => 
              fetch(`/api/member/${m.key}`, { cache: 'no-store' }).then(r => r.ok ? r.json() : null).catch(() => null)
            );
            const memberDetails = await Promise.all(memberDetailsPromises);

            for (let i = 0; i < members.length; i++) {
              const member = members[i];
              const memberDetail = memberDetails[i];
              
              // Skip if already evaluated
              if (hasBeenEvaluated(memberDetail, key, role)) continue;
              
              const { card, form, scores } = createEvaluationCard(member, criteriaData.criteria, criteriaData.ratingLevels, key, role);
              container.appendChild(card);
              evaluationCards.set(member.key, { card, form, scores, member, criteriaCount: criteriaData.criteria.length });
              allEvaluations.set(member.key, { scores: {}, form });
            }
          }

          // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ nh√≥m n√†o c·∫ßn ƒë√°nh gi√°
          if (evaluationCards.size === 0) {
            const noEvaluationMsg = document.createElement('div');
            noEvaluationMsg.className = 'card';
            noEvaluationMsg.style.textAlign = 'center';
            noEvaluationMsg.style.padding = '32px';
            noEvaluationMsg.style.marginTop = '24px';
            noEvaluationMsg.innerHTML = '<div class="card__body"><p style="color: #22c55e; font-size: 18px;">‚úì B·∫°n ƒë√£ ƒë√°nh gi√° ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c nh√≥m!</p></div>';
            container.appendChild(noEvaluationMsg);
            
            // Th√™m n√∫t Home cho visitor, member v√† admin
            if (role === 'visitor' || role === 'member' || role === 'admin') {
              const homeBtn = document.createElement('button');
              homeBtn.type = 'button';
              homeBtn.className = 'button button-action button-evaluate';
              homeBtn.textContent = 'Home';
              homeBtn.style.marginTop = '24px';
              homeBtn.style.width = 'auto';
              homeBtn.style.padding = '12px 32px';
              homeBtn.style.fontSize = '16px';
              homeBtn.addEventListener('click', () => {
                window.isEvaluationMode = false;
                window.location.reload();
              });
              container.appendChild(homeBtn);
            }
          }

          // Global submit button - ch·ªâ hi·ªÉn th·ªã khi c√≥ card ƒë·ªÉ ƒë√°nh gi√°
          if (evaluationCards.size > 0) {
            const globalSubmitBtn = document.createElement('button');
            globalSubmitBtn.type = 'button';
            globalSubmitBtn.className = 'button button-action button-evaluate';
            globalSubmitBtn.textContent = 'L∆∞u ƒë√°nh gi√°';
            globalSubmitBtn.style.display = 'none';
            globalSubmitBtn.style.marginTop = '24px';
            globalSubmitBtn.style.width = '100%';
            globalSubmitBtn.style.padding = '16px';
            globalSubmitBtn.style.fontSize = '18px';
            
            // Function to check if all evaluations are complete
            function checkAllEvaluationsComplete() {
              let allComplete = true;
              let incompleteGroups = [];
              
              evaluationCards.forEach((data, targetKey) => {
                const { scores, member, criteriaCount } = data;
                if (Object.keys(scores).length !== criteriaCount) {
                  allComplete = false;
                  incompleteGroups.push(member.key.toUpperCase());
                }
              });
              
              if (allComplete && evaluationCards.size > 0) {
                globalSubmitBtn.style.display = 'block';
              } else {
                globalSubmitBtn.style.display = 'none';
              }
              
              return { allComplete, incompleteGroups };
            }
            
            // Update submit button visibility when any score changes
            evaluationCards.forEach((data, targetKey) => {
              const { form, scores } = data;
              
              // Listen to form changes
              form.addEventListener('change', () => {
                checkAllEvaluationsComplete();
              });
            });
            
            globalSubmitBtn.addEventListener('click', async () => {
              const { allComplete, incompleteGroups } = checkAllEvaluationsComplete();
              
              if (!allComplete) {
                if (incompleteGroups.length > 0) {
                  alert(`Vui l√≤ng ƒë√°nh gi√° ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ ti√™u ch√≠ cho c√°c nh√≥m: ${incompleteGroups.join(', ')}`);
                } else {
                  alert('Vui l√≤ng ƒë√°nh gi√° ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c nh√≥m v√† ti√™u ch√≠');
                }
                return;
              }
              
              // Submit all evaluations
              const submitPromises = [];
              evaluationCards.forEach((data, targetKey) => {
                const { scores, member } = data;
                const scoreData = Object.values(scores).map(s => ({
                  id: s.id,
                  score: s.score
                }));
                
                submitPromises.push(
                  fetch('/api/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      evaluatorKey: key,
                      evaluatorRole: role,
                      targetKey: member.key,
                      scores: scoreData
                    })
                  })
                );
              });
              
              try {
                const results = await Promise.all(submitPromises);
                const allOk = results.every(r => r.ok);
                if (allOk) {
                  alert('ƒê√£ l∆∞u t·∫•t c·∫£ ƒë√°nh gi√° th√†nh c√¥ng!');
                  window.isEvaluationMode = false;
                  window.location.reload();
                } else {
                  const errors = await Promise.all(results.map(r => r.json().catch(() => ({ error: 'Unknown error' }))));
                  alert('L·ªói khi l∆∞u ƒë√°nh gi√°: ' + errors.map(e => e.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh').join(', '));
                }
              } catch (err) {
                alert('C√≥ l·ªói x·∫£y ra: ' + err.message);
              }
            });
            
            container.appendChild(globalSubmitBtn);
            
            // Initial check
            setTimeout(() => checkAllEvaluationsComplete(), 100);
          }

          // N√∫t Ho√†n th√†nh (ch·ªâ admin hi·ªÉn th·ªã)
          if (role === 'admin') {
            const finishBtn = document.createElement('button');
            finishBtn.className = 'button button-action button-evaluate';
            finishBtn.textContent = 'Ho√†n th√†nh ƒë√°nh gi√°';
            finishBtn.style.marginTop = '24px';
            finishBtn.addEventListener('click', async () => {
              if (!confirm('X√°c nh·∫≠n ho√†n th√†nh ƒë√°nh gi√° v√† t√≠nh ƒëi·ªÉm cu·ªëi c√πng?')) return;
              try {
                const res = await fetch('/api/evaluate/finalize', { method: 'POST' });
                const data = await res.json();
                if (!res.ok) {
                  alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ ho√†n th√†nh ƒë√°nh gi√°'));
                  return;
                }
                alert('ƒê√£ t√≠nh ƒëi·ªÉm th√†nh c√¥ng!');
                window.isEvaluationMode = false;
                window.location.reload();
              } catch (err) {
                alert('C√≥ l·ªói x·∫£y ra: ' + err.message);
              }
            });
            container.appendChild(finishBtn);
          }

          app.appendChild(container);
        } catch (err) {
          app.innerHTML = '<div class="card"><div class="card__body"><p style="color: #ef4444;">L·ªói: ' + err.message + '</p></div></div>';
        }
      }

      function createEvaluationCard(member, criteria, ratingLevels, evaluatorKey, evaluatorRole) {
        const card = document.createElement('div');
        card.className = 'card evaluation-card';
        
        const body = document.createElement('div');
        body.className = 'card__body';
        
        // Title: member key + name
        const evalHeader = document.createElement('div');
        evalHeader.className = 'evaluation-card-title';
        evalHeader.textContent = `${member.key.toUpperCase()} - ${member.name || 'Ch∆∞a c√≥ t√™n'}`;
        body.appendChild(evalHeader);
        
        const form = document.createElement('form');
        form.className = 'evaluation-form';
        
        const scores = {};
        let totalMaxScore = 0;
        
        // Function to calculate score from level
        function getScoreFromLevel(level, maxScore) {
          // Level 4 = 100%, Level 3 = 75%, Level 2 = 50%, Level 1 = 25%
          const percentage = [0, 0.25, 0.5, 0.75, 1.0];
          return Math.round(maxScore * percentage[level] * 100) / 100;
        }
        
        criteria.forEach(criterion => {
          totalMaxScore += criterion.maxScore;
          
          const row = document.createElement('div');
          row.className = 'evaluation-row';
          
          const header = document.createElement('div');
          header.className = 'evaluation-header';
          
          const title = document.createElement('div');
          title.className = 'evaluation-title-row';
          const titleText = document.createElement('span');
          titleText.className = 'evaluation-criterion-title';
          titleText.textContent = criterion.name;
          const maxScoreText = document.createElement('span');
          maxScoreText.className = 'evaluation-max-score';
          maxScoreText.textContent = `T·ªëi ƒëa: ${criterion.maxScore} ƒëi·ªÉm`;
          title.appendChild(titleText);
          title.appendChild(maxScoreText);
          header.appendChild(title);
          
          const options = document.createElement('div');
          options.className = 'evaluation-options';
          
          const selectedState = document.createElement('div');
          selectedState.className = 'evaluation-selected-state';
          selectedState.textContent = 'Ch∆∞a ch·ªçn';
          selectedState.id = `state-${criterion.id}`;
          
          // Sort rating levels in descending order (4, 3, 2, 1)
          const sortedLevels = [...ratingLevels].sort((a, b) => b.id - a.id);
          
          sortedLevels.forEach(level => {
            const label = document.createElement('label');
            label.className = 'evaluation-radio-option';
            
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = `criterion-${criterion.id}`;
            input.value = level.id;
            input.dataset.criterionId = criterion.id;
            input.dataset.maxScore = criterion.maxScore;
            input.dataset.levelId = level.id;
            
            input.addEventListener('change', () => {
              const score = getScoreFromLevel(level.id, criterion.maxScore);
              scores[criterion.id] = { id: criterion.id, score: score, levelId: level.id };
              selectedState.textContent = `${score} ƒëi·ªÉm`;
              selectedState.style.color = '#3b82f6';
              
              // Update active state
              options.querySelectorAll('.evaluation-radio-option').forEach(opt => {
                opt.classList.remove('active');
              });
              label.classList.add('active');
              
              updateTotalScore();
            });
            
            const emoji = document.createElement('span');
            emoji.className = 'evaluation-emoji';
            emoji.textContent = level.emoji;
            
            const text = document.createElement('span');
            text.className = 'evaluation-option-text';
            text.textContent = level.name;
            
            label.appendChild(input);
            label.appendChild(emoji);
            label.appendChild(text);
            options.appendChild(label);
          });
          
          row.appendChild(header);
          row.appendChild(options);
          row.appendChild(selectedState);
          form.appendChild(row);
        });

        // Total score display
        const totalScoreRow = document.createElement('div');
        totalScoreRow.className = 'evaluation-total-score';
        const totalScoreText = document.createElement('span');
        totalScoreText.className = 'evaluation-total-text';
        totalScoreText.textContent = 'T·ªïng ƒëi·ªÉm ƒë√°nh gi√°: ';
        const totalScoreValue = document.createElement('span');
        totalScoreValue.className = 'evaluation-total-value';
        totalScoreValue.textContent = '0';
        const totalScoreMax = document.createElement('span');
        totalScoreMax.className = 'evaluation-total-max';
        totalScoreMax.textContent = ` / ${totalMaxScore}`;
        totalScoreRow.appendChild(totalScoreText);
        totalScoreRow.appendChild(totalScoreValue);
        totalScoreRow.appendChild(totalScoreMax);
        form.appendChild(totalScoreRow);
        
        function updateTotalScore() {
          let total = 0;
          Object.values(scores).forEach(scoreData => {
            total += scoreData.score || 0;
          });
          totalScoreValue.textContent = Math.round(total * 100) / 100;
        }

        // Kh√¥ng th√™m submit button ri√™ng - s·∫Ω d√πng global submit button
        body.appendChild(form);
        card.appendChild(body);
        
        return { card, form, scores };
      }

      async function renderAdminDashboard() {
        const container = document.createElement('div');
        container.className = 'admin-dashboard';
        
        const titleBox = document.createElement('div');
        titleBox.className = 'dashboard-title-box';
        const title = document.createElement('h1');
        title.className = 'dashboard-title';
        title.textContent = 'L·ªõp 6/13';
        titleBox.appendChild(title);
        container.appendChild(titleBox);

        const grid = document.createElement('div');
        grid.className = 'dashboard-grid';

        // Block tr√°i: Danh s√°ch members
        const leftBlock = document.createElement('div');
        leftBlock.className = 'dashboard-block';
        const leftTitle = document.createElement('h2');
        leftTitle.textContent = 'Danh s√°ch nh√≥m';
        leftBlock.appendChild(leftTitle);
        const membersList = document.createElement('div');
        membersList.className = 'members-list';
        leftBlock.appendChild(membersList);
        grid.appendChild(leftBlock);

        // Block ph·∫£i: Danh s√°ch visitors online
        const rightBlock = document.createElement('div');
        rightBlock.className = 'dashboard-block';
        const rightTitle = document.createElement('h2');
        rightTitle.textContent = 'Th·∫ßy/C√¥ ƒëang online';
        rightBlock.appendChild(rightTitle);
        const visitorsList = document.createElement('div');
        visitorsList.className = 'visitors-list';
        rightBlock.appendChild(visitorsList);
        grid.appendChild(rightBlock);

        container.appendChild(grid);

        // Block d∆∞·ªõi c√πng: Action buttons
        const actionBlock = document.createElement('div');
        actionBlock.className = 'dashboard-actions';
        
        const evaluateBtn = document.createElement('button');
        evaluateBtn.className = 'button button-action button-evaluate';
        const evaluateIcon = document.createElement('span');
        evaluateIcon.className = 'button-icon';
        evaluateIcon.innerHTML = '‚≠ê';
        const evaluateText = document.createElement('span');
        evaluateText.textContent = 'ƒê√°nh gi√°';
        evaluateBtn.appendChild(evaluateIcon);
        evaluateBtn.appendChild(evaluateText);
        evaluateBtn.addEventListener('click', () => {
          if (window.socket && typeof window.socket.emit === 'function') {
            window.socket.emit('start_evaluation');
          } else {
            alert('Vui l√≤ng ƒë·ª£i k·∫øt n·ªëi Socket.IO');
          }
        });
        
        const endBtn = document.createElement('button');
        endBtn.className = 'button button-action button-finish';
        const endIcon = document.createElement('span');
        endIcon.className = 'button-icon';
        endIcon.innerHTML = 'üèÅ';
        const endText = document.createElement('span');
        endText.textContent = 'K·∫øt th√∫c';
        endBtn.appendChild(endIcon);
        endBtn.appendChild(endText);
        endBtn.addEventListener('click', () => {
          openFinalSummaryPopup();
        });
        
        const refreshBtn = document.createElement('button');
        refreshBtn.className = 'button button-action button-refresh';
        const refreshIcon = document.createElement('span');
        refreshIcon.className = 'button-icon';
        refreshIcon.innerHTML = 'üîÑ';
        const refreshText = document.createElement('span');
        refreshText.textContent = 'L√†m m·ªõi';
        refreshBtn.appendChild(refreshIcon);
        refreshBtn.appendChild(refreshText);
        refreshBtn.addEventListener('click', async () => {
          const confirmed = confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° to√†n b·ªô d·ªØ li·ªáu? D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c backup.\n\nNh·∫•n OK ƒë·ªÉ ti·∫øp t·ª•c, Cancel ƒë·ªÉ h·ªßy.');
          if (!confirmed) return;

          try {
            const res = await fetch('/api/admin/reset', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (!res.ok) {
              alert('L·ªói: ' + (data.error || 'L√†m m·ªõi th·∫•t b·∫°i'));
              return;
            }
            alert('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu th√†nh c√¥ng!\nFile backup: ' + data.backupFile);
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi
            window.location.reload();
          } catch (err) {
            alert('C√≥ l·ªói x·∫£y ra: ' + err.message);
          }
        });
        
        actionBlock.appendChild(evaluateBtn);
        actionBlock.appendChild(endBtn);
        actionBlock.appendChild(refreshBtn);
        container.appendChild(actionBlock);

        app.appendChild(container);

        // Load v√† render data
        await loadAndRenderMembers(membersList);
        await loadAndRenderVisitors(visitorsList);

        // Auto refresh every 5 seconds (reduced frequency to prevent jitter)
        let isRefreshing = false;

        // Listen for status changes
        if (window.socket && typeof window.socket.on === 'function') {
          window.socket.on('member_status_change', async () => {
            if (!isRefreshing) {
              isRefreshing = true;
              try {
                await Promise.all([
                  loadAndRenderMembers(membersList),
                  loadAndRenderVisitors(visitorsList)
                ]);
              } finally {
                isRefreshing = false;
              }
            }
          });
        }
        setInterval(async () => {
          if (isRefreshing) return;
          isRefreshing = true;
          try {
            await Promise.all([
              loadAndRenderMembers(membersList),
              loadAndRenderVisitors(visitorsList)
            ]);
          } finally {
            isRefreshing = false;
          }
        }, 5000);
      }

      async function loadAndRenderMembers(container) {
        try {
          const [membersRes, visitorsRes] = await Promise.all([
            fetch('/api/admin/members', { cache: 'no-store' }),
            fetch('/api/members?rule=visitor', { cache: 'no-store' })
          ]);
          if (!membersRes.ok) throw new Error('Failed to load members');
          const members = await membersRes.json();
          const visitors = visitorsRes.ok ? await visitorsRes.json() : [];
          
          // Batch fetch all member details in parallel
          const memberDetailsPromises = members.map(m => 
            fetch(`/api/member/${m.key}`, { cache: 'no-store' }).then(r => r.ok ? r.json() : null).catch(() => null)
          );
          const memberDetails = await Promise.all(memberDetailsPromises);
          
          // Create avatar map for quick lookup
          const avatarMap = new Map();
          memberDetails.forEach((md, idx) => {
            if (md && md.key) {
              avatarMap.set(md.key, md.avatar || 'üë§');
            }
          });
          
          // Create document fragment for smoother rendering
          const fragment = document.createDocumentFragment();
          
          members.forEach((m, idx) => {
            const memberDetail = memberDetails[idx];
            
            const item = document.createElement('div');
            item.className = 'member-item';
            const statusDot = document.createElement('span');
            statusDot.className = `member-dot status-dot ${m.isOnline ? 'online' : 'offline'}`;
            statusDot.title = m.isOnline ? 'ƒêang online' : 'ƒê√£ offline';
            const info = document.createElement('div');
            info.className = 'member-info';
            const keyName = document.createElement('div');
            keyName.className = 'member-key-name';
            keyName.textContent = `${m.key.toUpperCase()} - ${m.name || 'Ch∆∞a c√≥ t√™n'}`;
            const score = document.createElement('div');
            score.className = 'member-score';
            score.textContent = `ƒêi·ªÉm: ${m.score || 0}`;
            info.appendChild(keyName);
            info.appendChild(score);
            
            // Evaluation status box
            const evalStatusBox = document.createElement('div');
            evalStatusBox.className = 'member-eval-status-box';
            
            // √î 1: Ch·ªß ph√≤ng ƒë√£ ƒë√°nh gi√°
            const adminBox = document.createElement('div');
            adminBox.className = 'eval-status-cell';
            if (memberDetail && memberDetail.detail_score && memberDetail.detail_score.room && memberDetail.detail_score.room.score > 0) {
              const crownIcon = document.createElement('span');
              crownIcon.className = 'eval-icon crown-icon';
              crownIcon.textContent = 'üëë';
              crownIcon.title = 'Ch·ªß ph√≤ng ƒë√£ ƒë√°nh gi√°';
              adminBox.appendChild(crownIcon);
            }
            
            // √î 2: C√°c nh√≥m ƒë√£ ƒë√°nh gi√° - hi·ªÉn th·ªã avatar
            const memberBox = document.createElement('div');
            memberBox.className = 'eval-status-cell';
            if (memberDetail && memberDetail.detail_score) {
              members.forEach(other => {
                if (other.key !== m.key && memberDetail.detail_score[other.key] && memberDetail.detail_score[other.key].score > 0) {
                  const memberIcon = document.createElement('span');
                  memberIcon.className = 'eval-icon member-avatar-icon';
                  const avatar = avatarMap.get(other.key) || 'üë§';
                  memberIcon.textContent = avatar;
                  memberIcon.title = `${other.key.toUpperCase()} ƒë√£ ƒë√°nh gi√°`;
                  memberBox.appendChild(memberIcon);
                }
              });
            }
            
            // √î 3: Visitor ƒë√£ ƒë√°nh gi√°
            const visitorBox = document.createElement('div');
            visitorBox.className = 'eval-status-cell';
            if (memberDetail && memberDetail.detail_score) {
              visitors.forEach(v => {
                if (memberDetail.detail_score[v.key] && memberDetail.detail_score[v.key].score > 0) {
                  const visitorAvatar = document.createElement('span');
                  visitorAvatar.className = 'eval-icon visitor-avatar';
                  const firstLetter = (v.name || v.key || 'V').charAt(0).toUpperCase();
                  visitorAvatar.textContent = firstLetter;
                  visitorAvatar.title = `${v.name || v.key} ƒë√£ ƒë√°nh gi√°`;
                  visitorBox.appendChild(visitorAvatar);
                }
              });
            }
            
            evalStatusBox.appendChild(adminBox);
            evalStatusBox.appendChild(memberBox);
            evalStatusBox.appendChild(visitorBox);
            
            const detailBtn = document.createElement('button');
            detailBtn.className = 'button button-small';
            detailBtn.textContent = 'Xem chi ti·∫øt';
            detailBtn.addEventListener('click', () => {
              openMemberDetailPopup(m.key);
            });
            item.appendChild(statusDot);
            item.appendChild(info);
            item.appendChild(evalStatusBox);
            item.appendChild(detailBtn);
            fragment.appendChild(item);
          });
          
          container.innerHTML = '';
          container.appendChild(fragment);
        } catch (err) {
          container.innerHTML = '<p style="color: #ef4444;">L·ªói t·∫£i danh s√°ch nh√≥m</p>';
        }
      }

      async function loadAndRenderVisitors(container) {
        try {
          const res = await fetch('/api/admin/visitors', { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to load visitors');
          const visitors = await res.json();

          // Build evaluation status map by checking member detail scores from member.json
          const visitorEvalStatus = new Map();
          try {
            const memberRes = await fetch('/database/member.json', { cache: 'no-store' });
            if (memberRes.ok) {
              const memberData = await memberRes.json();
              const memberList = Array.isArray(memberData?.members)
                ? memberData.members.filter(m => (m.rule || '').toLowerCase() === 'member')
                : [];

              memberList.forEach(member => {
                const detailScore = member?.detail_score || {};
                Object.entries(detailScore).forEach(([evaluatorKey, evaluatorScore]) => {
                  const normalizedKey = (evaluatorKey || '').toLowerCase();
                  if (!normalizedKey) return;

                  const totalScore = typeof evaluatorScore?.score === 'number' ? evaluatorScore.score : 0;
                  const criteriaScores = Array.isArray(evaluatorScore?.criteria)
                    ? evaluatorScore.criteria
                    : (Array.isArray(evaluatorScore?.detail) ? evaluatorScore.detail : []);
                  const hasCriteriaScore = Array.isArray(criteriaScores)
                    ? criteriaScores.some(c => (c?.score || 0) > 0)
                    : false;

                  if (totalScore > 0 || hasCriteriaScore) {
                    visitorEvalStatus.set(normalizedKey, true);
                  } else if (!visitorEvalStatus.has(normalizedKey)) {
                    visitorEvalStatus.set(normalizedKey, false);
                  }
                });
              });
            }
          } catch (scoreErr) {
            console.warn('Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i ƒë√°nh gi√° c·ªßa Th·∫ßy/C√¥:', scoreErr);
          }

          container.innerHTML = '';
          if (visitors.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">Ch∆∞a c√≥ Th·∫ßy/C√¥ n√†o ƒëang online</p>';
            return;
          }
          visitors.forEach(v => {
            const item = document.createElement('div');
            item.className = 'visitor-item';
            const keyName = document.createElement('div');
            keyName.className = 'visitor-key-name';
            keyName.textContent = `Th·∫ßy/c√¥: ${v.name || 'Ch∆∞a c√≥ t√™n'}`;
            const evaluated = document.createElement('div');
            evaluated.className = 'visitor-evaluated';
            const normalizedVisitorKey = (v.key || v.id || v.slug || '').toLowerCase();
            const evaluatedFromMembers = normalizedVisitorKey
              ? visitorEvalStatus.get(normalizedVisitorKey) === true
              : false;
            const hasEvaluated =
              evaluatedFromMembers ||
              !!(v.hasEvaluated ?? v.has_evaluated ?? v.evaluated ?? v.evaluated_at ?? v.evaluatedAt);
            evaluated.textContent = hasEvaluated ? 'ƒê√£ ƒë√°nh gi√°' : 'Ch∆∞a ƒë√°nh gi√°';
            evaluated.style.color = hasEvaluated ? '#22c55e' : '#f59e0b';
            item.appendChild(keyName);
            item.appendChild(evaluated);
            container.appendChild(item);
          });
        } catch (err) {
          container.innerHTML = '<p style="color: #ef4444;">L·ªói t·∫£i danh s√°ch Th·∫ßy/C√¥</p>';
        }
      }

      if (!params.has('key')) {
        renderForm();
      } else {
        renderSummary();
      }
    })();

    async function openFinalSummaryPopup() {
      const existing = document.querySelector('.modal-overlay.final-summary-overlay');
      if (existing) {
        document.body.removeChild(existing);
      }

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay final-summary-overlay';

      const modal = document.createElement('div');
      modal.className = 'modal';

      const header = document.createElement('div');
      header.className = 'modal-header';

      const title = document.createElement('h3');
      title.className = 'modal-title';
      title.textContent = 'K·∫øt th√∫c ƒë√°nh gi√°';

      const closeBtn = document.createElement('button');
      closeBtn.className = 'button button-small modal-close';
      closeBtn.textContent = 'ƒê√≥ng';
      closeBtn.addEventListener('click', () => {
        if (document.body.contains(overlay)) {
          document.body.removeChild(overlay);
        }
      });

      header.appendChild(title);
      header.appendChild(closeBtn);

      const content = document.createElement('div');
      content.className = 'modal-content final-summary-content';

      const rankingList = document.createElement('div');
      rankingList.className = 'final-ranking-list';
      const loadingState = document.createElement('div');
      loadingState.className = 'final-ranking-loading';
      loadingState.innerHTML = '<span class="final-ranking-spinner"></span><span>ƒêang t·∫£i k·∫øt qu·∫£...</span>';
      rankingList.appendChild(loadingState);
      content.appendChild(rankingList);

      modal.appendChild(header);
      modal.appendChild(content);
      overlay.appendChild(modal);

      overlay.addEventListener('click', (event) => {
        if (event.target === overlay && document.body.contains(overlay)) {
          document.body.removeChild(overlay);
        }
      });

      document.body.appendChild(overlay);

      try {
        const res = await fetch('/database/member.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');

        const data = await res.json();
        const members = Array.isArray(data?.members) ? data.members : [];
        const memberRankings = members
          .filter(m => (m.rule || '').toLowerCase() === 'member')
          .sort((a, b) => (b.score || 0) - (a.score || 0));

        rankingList.innerHTML = '';

        if (!memberRankings.length) {
          const emptyState = document.createElement('p');
          emptyState.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng.';
          rankingList.appendChild(emptyState);
          return;
        }

        memberRankings.forEach((member, idx) => {
          const item = document.createElement('div');
          item.className = 'final-ranking-item';
          if (idx === 0) item.classList.add('final-ranking-item-first');
          if (idx === 1) item.classList.add('final-ranking-item-second');
          if (idx === 2) item.classList.add('final-ranking-item-third');

          const rankBadge = document.createElement('div');
          rankBadge.className = 'final-ranking-rank';
          rankBadge.textContent = `#${idx + 1}`;
          item.appendChild(rankBadge);

          const avatarWrap = document.createElement('div');
          avatarWrap.className = 'final-ranking-avatar';
          const avatar = member.avatar && member.avatar.trim()
            ? member.avatar.trim()
            : (member.name && member.name.trim()
              ? member.name.trim().charAt(0).toUpperCase()
              : (member.key ? member.key.charAt(0).toUpperCase() : 'üèÖ'));
          avatarWrap.textContent = avatar;
          item.appendChild(avatarWrap);

          const info = document.createElement('div');
          info.className = 'final-ranking-info';

          const name = document.createElement('div');
          name.className = 'final-ranking-name';
          name.textContent = member.name && member.name.trim() ? member.name.trim() : 'Ch∆∞a c√≥ t√™n';

          const meta = document.createElement('div');
          meta.className = 'final-ranking-meta';
          meta.textContent = member.key ? member.key.toUpperCase() : 'N/A';

          info.appendChild(name);
          info.appendChild(meta);

          item.appendChild(info);

          const scoreWrap = document.createElement('div');
          scoreWrap.className = 'final-ranking-score';
          const rawScore = typeof member.score === 'number' ? member.score : 0;
          const scoreValue = Math.ceil(rawScore);
          scoreWrap.innerHTML = `
            <span class="score-icon-bulb">üí°</span>
            <span class="score-number-badge">
              <span class="score-number">${scoreValue}</span>
            </span>
          `;
          item.appendChild(scoreWrap);

          rankingList.appendChild(item);
        });
      } catch (error) {
        rankingList.innerHTML = '';
        const errorState = document.createElement('p');
        errorState.style.color = '#ef4444';
        errorState.textContent = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu x·∫øp h·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.';
        rankingList.appendChild(errorState);
        console.error(error);
      }
    }

    // Modal detail for member breakdown
    async function openMemberDetailPopup(memberKey) {
      try {
        const [memberRes, roomCritRes, memberCritRes] = await Promise.all([
          fetch(`/api/member/${memberKey}`, { cache: 'no-store' }),
          fetch('/api/criteria/roomCriteria', { cache: 'no-store' }),
          fetch('/api/criteria/memberCriteria', { cache: 'no-store' })
        ]);
        if (!memberRes.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu nh√≥m');
        const member = await memberRes.json();
        const roomCrit = await roomCritRes.json();
        const memCrit = await memberCritRes.json();

        const ratingLevels = (roomCrit.ratingLevels && roomCrit.ratingLevels.length)
          ? roomCrit.ratingLevels
          : (memCrit.ratingLevels || []);

        function sumMaxScore(criteria) {
          return (criteria || []).reduce((s, c) => s + (c.maxScore || 0), 0);
        }

        function getExpectedScoreForLevel(levelId, maxScore) {
          const percentage = [0, 0.25, 0.5, 0.75, 1.0];
          return Math.round(maxScore * percentage[levelId] * 100) / 100;
        }

        function inferLevelByScore(score, maxScore) {
          if (!maxScore || score <= 0) return null;
          let best = { level: null, diff: Infinity };
          ratingLevels.forEach(lvl => {
            const expected = getExpectedScoreForLevel(lvl.id, maxScore);
            const diff = Math.abs((score || 0) - expected);
            if (diff < best.diff) best = { level: lvl, diff };
          });
          return best.level;
        }

        // Helper function to render rating levels as buttons
        function renderRatingLevels(criterion, selectedLevel, score, maxScore) {
          const container = document.createElement('div');
          container.className = 'detail-criterion-row';
          
          const criterionName = document.createElement('div');
          criterionName.className = 'detail-criterion-name';
          criterionName.textContent = criterion.name || ('Ti√™u ch√≠ ' + criterion.id);
          container.appendChild(criterionName);
          
          const scoreText = document.createElement('div');
          scoreText.className = 'detail-criterion-score';
          if (score > 0) {
            scoreText.appendChild(document.createTextNode('('));
            const scoreSpan = document.createElement('span');
            scoreSpan.style.fontWeight = 'bold';
            scoreSpan.style.color = '#ef4444';
            scoreSpan.textContent = score;
            scoreText.appendChild(scoreSpan);
            scoreText.appendChild(document.createTextNode(`/${maxScore})`));
          } else {
            scoreText.textContent = 'Ch∆∞a ƒë√°nh gi√°';
          }
          container.appendChild(scoreText);
          
          const levelsContainer = document.createElement('div');
          levelsContainer.className = 'detail-rating-levels';
          
          // Sort rating levels in descending order (4, 3, 2, 1)
          const sortedLevels = [...ratingLevels].sort((a, b) => b.id - a.id);
          
          sortedLevels.forEach(level => {
            const levelBtn = document.createElement('div');
            levelBtn.className = 'detail-rating-btn';
            
            const isSelected = selectedLevel && selectedLevel.id === level.id;
            if (isSelected) {
              levelBtn.classList.add('detail-rating-btn-selected');
            }
            
            const emoji = document.createElement('span');
            emoji.className = 'detail-rating-emoji';
            emoji.textContent = level.emoji || '';
            
            const text = document.createElement('span');
            text.className = 'detail-rating-text';
            text.textContent = level.name || '';
            
            levelBtn.appendChild(emoji);
            levelBtn.appendChild(text);
            levelsContainer.appendChild(levelBtn);
          });
          
          container.appendChild(levelsContainer);
          
          return container;
        }

        // Build modal
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        const title = document.createElement('h3');
        title.className = 'modal-title';
        title.textContent = `${member.key.toUpperCase()} - ${member.name || 'Ch∆∞a c√≥ t√™n'}`;
        const closeBtn = document.createElement('button');
        closeBtn.className = 'button button-small modal-close';
        closeBtn.textContent = 'ƒê√≥ng';
        closeBtn.addEventListener('click', () => document.body.removeChild(overlay));
        header.appendChild(title);
        header.appendChild(closeBtn);

        const content = document.createElement('div');
        content.className = 'modal-content';

        // Total current score
        const totalBox = document.createElement('div');
        totalBox.className = 'detail-total-box';
        totalBox.innerHTML = `<strong>T·ªïng ƒëi·ªÉm hi·ªán c√≥:</strong> <span class="detail-total-score">${member.score || 0}</span>`;
        content.appendChild(totalBox);

        // Section: ƒêi·ªÉm ch·ªß ph√≤ng
        const adminSection = document.createElement('div');
        adminSection.className = 'detail-section';
        const adminTitle = document.createElement('h4');
        const roomMax = sumMaxScore(roomCrit.criteria);
        const roomScore = (member.detail_score && member.detail_score.room && member.detail_score.room.score) || 0;
        adminTitle.textContent = `ƒêi·ªÉm ch·ªß ph√≤ng (${roomScore}/${roomMax})`;
        adminSection.appendChild(adminTitle);
        const adminList = document.createElement('div');
        adminList.className = 'detail-list';
        (roomCrit.criteria || []).forEach(c => {
          const item = (member.detail_score && member.detail_score.room && member.detail_score.room.criteria || []).find(x => x.id === c.id);
          const score = item ? item.score : 0;
          const selectedLevel = item ? inferLevelByScore(item.score, c.maxScore) : null;
          const criterionRow = renderRatingLevels(c, selectedLevel, score, c.maxScore);
          adminList.appendChild(criterionRow);
        });
        adminSection.appendChild(adminList);
        content.appendChild(adminSection);

        // Section: Avg ƒëi·ªÉm c√°c nh√≥m
        const memberSection = document.createElement('div');
        memberSection.className = 'detail-section';
        const memberMax = sumMaxScore(memCrit.criteria);
        const otherMembers = (await (await fetch('/api/admin/members', { cache: 'no-store' })).json()).map(m => m.key).filter(k => k !== member.key);
        const perMemberScores = [];
        const memberList = document.createElement('div');
        memberList.className = 'detail-list';
        otherMembers.forEach(k => {
          const entry = member.detail_score && member.detail_score[k];
          const sc = entry && typeof entry.score === 'number' ? entry.score : 0;
          perMemberScores.push(sc);
          
          // Member header
          const memberHeader = document.createElement('div');
          memberHeader.className = 'detail-member-header';
          memberHeader.textContent = `ƒêi·ªÉm ${k.toUpperCase()} (${sc}/${memberMax})`;
          memberList.appendChild(memberHeader);
          
          // criteria breakdown under each
          const sub = document.createElement('div');
          sub.className = 'detail-sublist';
          (memCrit.criteria || []).forEach(c => {
            const found = entry && entry.criteria ? entry.criteria.find(x => x.id === c.id) : null;
            const score = found ? found.score : 0;
            const selectedLevel = found ? inferLevelByScore(found.score, c.maxScore) : null;
            const criterionRow = renderRatingLevels(c, selectedLevel, score, c.maxScore);
            sub.appendChild(criterionRow);
          });
          memberList.appendChild(sub);
        });
        const memberAvg = perMemberScores.length ? Math.round((perMemberScores.reduce((a,b)=>a+b,0)/perMemberScores.length)*100)/100 : 0;
        const memberTitle = document.createElement('h4');
        memberTitle.textContent = `Trung b√¨nh ƒëi·ªÉm c√°c nh√≥m (${memberAvg}/${memberMax})`;
        memberSection.appendChild(memberTitle);
        memberSection.appendChild(memberList);
        content.appendChild(memberSection);

        // Section: Visitor
        const visitorSection = document.createElement('div');
        visitorSection.className = 'detail-section';
        const visitorsRes = await fetch('/api/members?rule=visitor', { cache: 'no-store' });
        const visitors = visitorsRes.ok ? await visitorsRes.json() : [];
        const visitorList = document.createElement('div');
        visitorList.className = 'detail-list';
        const visitorScores = [];
        visitors.forEach(v => {
          const k = v.key;
          const entry = member.detail_score && member.detail_score[k];
          const sc = entry && typeof entry.score === 'number' ? entry.score : 0;
          if (sc > 0) {
            visitorScores.push(sc);
            
            // Visitor header
            const visitorHeader = document.createElement('div');
            visitorHeader.className = 'detail-member-header';
            visitorHeader.textContent = `ƒêi·ªÉm ${v.name || k} (${sc}/${memberMax})`;
            visitorList.appendChild(visitorHeader);
            
            // criteria breakdown under each
            const sub = document.createElement('div');
            sub.className = 'detail-sublist';
            (memCrit.criteria || []).forEach(c => {
              const found = entry && entry.criteria ? entry.criteria.find(x => x.id === c.id) : null;
              const score = found ? found.score : 0;
              const selectedLevel = found ? inferLevelByScore(found.score, c.maxScore) : null;
              const criterionRow = renderRatingLevels(c, selectedLevel, score, c.maxScore);
              sub.appendChild(criterionRow);
            });
            visitorList.appendChild(sub);
          }
        });
        const visitorAvg = visitorScores.length ? Math.round((visitorScores.reduce((a,b)=>a+b,0)/visitorScores.length)*100)/100 : 0;
        const visitorTitle = document.createElement('h4');
        visitorTitle.textContent = `Trung b√¨nh ƒëi·ªÉm Th·∫ßy/C√¥ (${visitorAvg}/${memberMax})`;
        visitorSection.appendChild(visitorTitle);
        visitorSection.appendChild(visitorList);
        content.appendChild(visitorSection);

        modal.appendChild(header);
        modal.appendChild(content);
        overlay.appendChild(modal);
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) document.body.removeChild(overlay);
        });
        document.body.appendChild(overlay);
      } catch (err) {
        alert('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt: ' + err.message);
      }
    }

    // Socket.IO Status Indicator - Ch·ªâ k·∫øt n·ªëi sau khi tham gia
    (function() {
      const statusEl = document.getElementById('socket-status');
      let socket = null;
      const urlParams = new URLSearchParams(window.location.search);

      function updateStatus(text, className) {
        statusEl.textContent = text;
        statusEl.className = 'socket-status ' + className;
      }

      function initSocket() {
        // Ch·ªâ k·∫øt n·ªëi n·∫øu ƒë√£ c√≥ params key (ƒë√£ tham gia)
        if (!urlParams.has('key')) {
          statusEl.style.display = 'none';
          return null;
        }

        statusEl.style.display = 'flex';
        updateStatus('ƒêang k·∫øt n·ªëi', 'connecting');
        
        if (typeof window.io !== 'function') {
          updateStatus('M·∫•t k·∫øt n·ªëi', 'disconnected');
          return null;
        }

        socket = io();

        socket.on('connect', () => {
          updateStatus('ƒê√£ k·∫øt n·ªëi', 'connected');
          // Register v·ªõi server khi connect
          const key = urlParams.get('key');
          if (key) {
            socket.emit('register', { key });
          }
        });

        socket.on('disconnect', (reason) => {
          updateStatus('M·∫•t k·∫øt n·ªëi', 'disconnected');
        });

        socket.on('connect_error', () => {
          updateStatus('M·∫•t k·∫øt n·ªëi', 'disconnected');
        });

        socket.io.on('reconnect_attempt', () => {
          updateStatus('ƒêang k·∫øt n·ªëi', 'connecting');
        });

        socket.io.on('reconnect', () => {
          updateStatus('ƒê√£ k·∫øt n·ªëi', 'connected');
          // Register l·∫°i khi reconnect
          const key = urlParams.get('key');
          if (key) {
            socket.emit('register', { key });
          }
        });

        // Listen for evaluation mode
        socket.on('evaluation_mode_started', () => {
          window.isEvaluationMode = true;
          if (typeof window.renderEvaluationForm === 'function') {
            window.renderEvaluationForm();
          }
        });

        return socket;
      }

      initSocket();
      // Store socket globally ƒë·ªÉ d√πng ·ªü renderAdminDashboard
      window.socket = socket;
    })();
  </script>
</body>
</html>
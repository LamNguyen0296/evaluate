<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluate</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="overlay"></div>
  <div id="socket-status" class="socket-status"></div>
  <div id="app" class="page"></div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    (function () {
      const app = document.getElementById('app');
      const params = new URLSearchParams(window.location.search);
      window.isEvaluationMode = false;

      function row(labelNode, inputNode) {
        const line = document.createElement('div');
        line.className = 'form-row';
        const lbl = document.createElement('div');
        lbl.className = 'label';
        lbl.appendChild(labelNode);
        const field = document.createElement('div');
        field.className = 'field';
        field.appendChild(inputNode);
        line.appendChild(lbl);
        line.appendChild(field);
        return line;
      }

      function createCard(titleText) {
        const card = document.createElement('div');
        card.className = 'card';
        const header = document.createElement('div');
        header.className = 'card__header';
        const h = document.createElement('h2');
        h.className = 'card__title';
        h.textContent = titleText;
        header.appendChild(h);
        const body = document.createElement('div');
        body.className = 'card__body';
        card.appendChild(header);
        card.appendChild(body);
        return { card, body };
      }

      function createCardNoHeader() {
        const card = document.createElement('div');
        card.className = 'card';
        const body = document.createElement('div');
        body.className = 'card__body';
        card.appendChild(body);
        return { card, body };
      }

      async function fetchMembers() {
        const res = await fetch('/api/members?rule=member', { cache: 'no-store' });
        if (!res.ok) throw new Error('T·∫£i nh√≥m th·∫•t b·∫°i');
        return await res.json();
      }

      function renderForm() {
        app.innerHTML = '';
        const { card, body } = createCard('Tham gia ƒë√°nh gi√°');
        const form = document.createElement('form');

        // Row 1: radio role
        const radiosWrap = document.createElement('div');
        radiosWrap.className = 'radio-group';
        const roles = [
          { value: 'admin', label: 'Ch·ªß ph√≤ng' },
          { value: 'member', label: 'Nh√≥m' },
          { value: 'visitor', label: 'Th·∫ßy/C√¥' },
        ];
        roles.forEach(r => {
          const id = 'role-' + r.value;
          const label = document.createElement('label');
          label.className = 'radio';
          label.htmlFor = id;
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'role';
          input.value = r.value;
          input.id = id;
          label.appendChild(input);
          const span = document.createElement('span');
          span.textContent = ' ' + r.label;
          label.appendChild(span);
          radiosWrap.appendChild(label);
        });
        form.appendChild(row(document.createTextNode('Quy·ªÅn'), radiosWrap));

        // Row 2: select group (only for member)
        const groupSelect = document.createElement('select');
        groupSelect.name = 'groupKey';
        groupSelect.className = 'select';
        const groupRow = row(document.createTextNode('Ch·ªçn nh√≥m'), groupSelect);
        groupRow.style.display = 'none';
        form.appendChild(groupRow);

        // Row 3: name (hidden for admin)
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.name = 'name';
        nameInput.placeholder = 'T√™n hi·ªÉn th·ªã';
        nameInput.className = 'input';
        const nameRow = row(document.createTextNode('T√™n'), nameInput);
        nameRow.style.display = 'none';
        form.appendChild(nameRow);

        // Row 4: submit
        const submit = document.createElement('button');
        submit.type = 'submit';
        submit.textContent = 'Tham gia';
        submit.className = 'button';
        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.appendChild(submit);
        form.appendChild(row(document.createTextNode(''), actions));

        // Role change effects
        form.addEventListener('change', async (e) => {
          if (e.target && e.target.name === 'role') {
            const role = e.target.value;
            if (role === 'member') {
              nameRow.style.display = '';
              groupRow.style.display = '';
              // load groups
              try {
                const groups = await fetchMembers();
                groupSelect.innerHTML = '<option value="">-- Ch·ªçn nh√≥m --</option>';
                groups.forEach(g => {
                  const opt = document.createElement('option');
                  opt.value = g.key;
                  opt.textContent = g.key.toUpperCase();
                  groupSelect.appendChild(opt);
                });
              } catch (err) {
                alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch nh√≥m');
              }
            } else if (role === 'visitor') {
              groupRow.style.display = 'none';
              nameRow.style.display = '';
            } else {
              groupRow.style.display = 'none';
              nameRow.style.display = 'none';
            }
          }
        });

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(form);
          const role = (fd.get('role') || '').toString();
          const groupKey = (fd.get('groupKey') || '').toString();
          const name = (fd.get('name') || '').toString().trim();
          if (!role) return alert('Vui l√≤ng ch·ªçn quy·ªÅn');
          if (role === 'member' && !groupKey) return alert('Vui l√≤ng ch·ªçn nh√≥m');
          if ((role === 'member' || role === 'visitor') && !name) return alert('Vui l√≤ng nh·∫≠p t√™n');
          try {
            const res = await fetch('/api/join', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ role, groupKey, name })
            });
            const data = await res.json();
            if (!res.ok) {
              alert(data.error || 'Tham gia th·∫•t b·∫°i');
              return;
            }
            const next = new URL(window.location.href);
            next.searchParams.set('key', data.key);
            next.searchParams.set('role', data.role);
            if (data.name) next.searchParams.set('name', data.name); else next.searchParams.delete('name');
            window.location.replace(next.toString());
          } catch (err) {
            alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i');
          }
        });

        body.appendChild(form);
        app.appendChild(card);
      }

      async function renderSummary() {
        app.innerHTML = '';
        const role = params.get('role') || '‚Äî';
        const key = params.get('key') || '‚Äî';
        const name = params.get('name') || '';

        if (role === 'admin') {
          await renderAdminDashboard();
        } else if (role === 'member') {
          await renderMemberDashboard(key);
        } else {
          const { card, body } = createCard('Th√¥ng tin truy c·∫≠p');
          const wrap = document.createElement('div');
          wrap.className = 'summary';
          const p1 = document.createElement('p');
          p1.textContent = `Rule: ${role}`;
          const p2 = document.createElement('p');
          p2.textContent = `Account key: ${key}`;
          wrap.appendChild(p1);
          wrap.appendChild(p2);
          if (role === 'visitor') {
            const p3 = document.createElement('p');
            p3.textContent = `T√™n: ${name || '‚Äî'}`;
            wrap.appendChild(p3);
            // N√∫t ƒê√°nh gi√° cho visitor
            const evalBtn = document.createElement('button');
            evalBtn.textContent = 'ƒê√°nh gi√°';
            evalBtn.className = 'button button-action button-evaluate';
            evalBtn.addEventListener('click', () => {
              window.isEvaluationMode = true;
              if (typeof window.renderEvaluationForm === 'function') {
                window.renderEvaluationForm();
              }
            });
            body.appendChild(evalBtn);
          }
          const back = document.createElement('button');
          back.textContent = 'ƒê·ªïi l·ª±a ch·ªçn';
          back.className = 'button';
          back.addEventListener('click', () => {
            const url = new URL(window.location.href);
            url.search = '';
            window.location.replace(url.toString());
          });
          body.appendChild(wrap);
          body.appendChild(back);
          app.appendChild(card);
        }
      }

      async function renderMemberDashboard(key) {
        try {
          const [memberRes, roomCritRes, memberCritRes] = await Promise.all([
            fetch(`/api/member/${key}`, { cache: 'no-store' }),
            fetch('/api/criteria/roomCriteria', { cache: 'no-store' }),
            fetch('/api/criteria/memberCriteria', { cache: 'no-store' })
          ]);
          if (!memberRes.ok) throw new Error('Failed to load member data');
          const member = await memberRes.json();
          const roomCrit = await roomCritRes.json();
          const memCrit = await memberCritRes.json();

          const ratingLevels = (roomCrit.ratingLevels && roomCrit.ratingLevels.length)
            ? roomCrit.ratingLevels
            : (memCrit.ratingLevels || []);

          function sumMaxScore(criteria) {
            return (criteria || []).reduce((s, c) => s + (c.maxScore || 0), 0);
          }

          function getExpectedScoreForLevel(levelId, maxScore) {
            const percentage = [0, 0.25, 0.5, 0.75, 1.0];
            return Math.round(maxScore * percentage[levelId] * 100) / 100;
          }

          function inferLevelByScore(score, maxScore) {
            if (!maxScore || score <= 0) return null;
            let best = { level: null, diff: Infinity };
            ratingLevels.forEach(lvl => {
              const expected = getExpectedScoreForLevel(lvl.id, maxScore);
              const diff = Math.abs((score || 0) - expected);
              if (diff < best.diff) best = { level: lvl, diff };
            });
            return best.level;
          }

          const { card, body } = createCardNoHeader();
          
          // Header row: Avatar + Key + Name + Score (1 line)
          const headerRow = document.createElement('div');
          headerRow.className = 'member-header-row';
          
          const avatar = document.createElement('div');
          avatar.className = 'member-avatar';
          avatar.textContent = member.avatar || 'üë§';
          
          const keyDiv = document.createElement('div');
          keyDiv.className = 'member-key';
          keyDiv.textContent = member.key.toUpperCase();
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'member-name';
          nameDiv.textContent = member.name || 'Ch∆∞a c√≥ t√™n';
          
          const scoreDiv = document.createElement('div');
          scoreDiv.className = 'member-score-header';
          const scoreIcon = document.createElement('span');
          scoreIcon.className = 'score-icon';
          scoreIcon.textContent = '‚≠ê';
          const scoreValue = document.createElement('span');
          scoreValue.textContent = member.score || 0;
          scoreDiv.appendChild(scoreIcon);
          scoreDiv.appendChild(scoreValue);
          
          headerRow.appendChild(avatar);
          headerRow.appendChild(keyDiv);
          headerRow.appendChild(nameDiv);
          headerRow.appendChild(scoreDiv);
          
          const infoSection = document.createElement('div');
          infoSection.className = 'member-info-section';
          
          // N√∫t ƒê√°nh gi√° cho member (di chuy·ªÉn l√™n tr√™n)
          const actionRow = document.createElement('div');
          actionRow.className = 'dashboard-actions';
          actionRow.style.marginBottom = '24px';
          const evalBtn = document.createElement('button');
          evalBtn.className = 'button button-action button-evaluate';
          const evalIcon = document.createElement('span');
          evalIcon.className = 'button-icon';
          evalIcon.innerHTML = '‚≠ê';
          const evalText = document.createElement('span');
          evalText.textContent = 'ƒê√°nh gi√°';
          evalBtn.appendChild(evalIcon);
          evalBtn.appendChild(evalText);
          evalBtn.addEventListener('click', () => {
            window.isEvaluationMode = true;
            if (typeof window.renderEvaluationForm === 'function') {
              window.renderEvaluationForm();
            }
          });
          actionRow.appendChild(evalBtn);
          
          // ƒêi·ªÉm t·ª´ng ph·∫ßn - hi·ªÉn th·ªã breakdown gi·ªëng admin
          const detailSection = document.createElement('div');
          detailSection.className = 'member-detail-section';
          const detailTitle = document.createElement('h3');
          detailTitle.textContent = 'ƒêi·ªÉm t·ª´ng ph·∫ßn';
          detailSection.appendChild(detailTitle);

          // Total current score
          const totalBox = document.createElement('div');
          totalBox.className = 'detail-total-box';
          totalBox.innerHTML = `<strong>T·ªïng ƒëi·ªÉm hi·ªán c√≥:</strong> <span class="detail-total-score">${member.score || 0}</span>`;
          detailSection.appendChild(totalBox);

          // Section: ƒêi·ªÉm ch·ªß ph√≤ng
          const adminSection = document.createElement('div');
          adminSection.className = 'detail-section';
          const adminTitle = document.createElement('h4');
          const roomMax = sumMaxScore(roomCrit.criteria);
          const roomScore = (member.detail_score && member.detail_score.room && member.detail_score.room.score) || 0;
          adminTitle.textContent = `ƒêi·ªÉm ch·ªß ph√≤ng (${roomScore}/${roomMax})`;
          adminSection.appendChild(adminTitle);
          const adminList = document.createElement('ul');
          adminList.className = 'detail-list';
          (roomCrit.criteria || []).forEach(c => {
            const li = document.createElement('li');
            const item = (member.detail_score && member.detail_score.room && member.detail_score.room.criteria || []).find(x => x.id === c.id);
            if (item) {
              const lvl = inferLevelByScore(item.score, c.maxScore);
              const label = lvl ? `${lvl.emoji || ''} ${lvl.name}`.trim() : '‚Äî';
              li.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: ${label} (${item.score} ƒëi·ªÉm)`;
            } else {
              li.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: Ch∆∞a ƒë√°nh gi√°`;
            }
            adminList.appendChild(li);
          });
          adminSection.appendChild(adminList);
          detailSection.appendChild(adminSection);

          // Section: Avg ƒëi·ªÉm c√°c nh√≥m
          (async () => {
            const memberMax = sumMaxScore(memCrit.criteria);
            const otherMembers = (await (await fetch('/api/admin/members', { cache: 'no-store' })).json()).map(m => m.key).filter(k => k !== member.key);
            const perMemberScores = [];
            const memberSection = document.createElement('div');
            memberSection.className = 'detail-section';
            const memberList = document.createElement('ul');
            memberList.className = 'detail-list';
            otherMembers.forEach(k => {
              const entry = member.detail_score && member.detail_score[k];
              const sc = entry && typeof entry.score === 'number' ? entry.score : 0;
              perMemberScores.push(sc);
              const li = document.createElement('li');
              li.textContent = `ƒêi·ªÉm ${k.toUpperCase()} (${sc}/${memberMax})`;
              memberList.appendChild(li);
              if (entry && entry.criteria && entry.criteria.length) {
                const sub = document.createElement('ul');
                sub.className = 'detail-sublist';
                (memCrit.criteria || []).forEach(c => {
                  const found = entry.criteria.find(x => x.id === c.id);
                  const subLi = document.createElement('li');
                  if (found) {
                    const lvl = inferLevelByScore(found.score, c.maxScore);
                    const label = lvl ? `${lvl.emoji || ''} ${lvl.name}`.trim() : '‚Äî';
                    subLi.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: ${label} (${found.score} ƒëi·ªÉm)`;
                  } else {
                    subLi.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: Ch∆∞a ƒë√°nh gi√°`;
                  }
                  sub.appendChild(subLi);
                });
                memberList.appendChild(sub);
              }
            });
            const memberAvg = perMemberScores.length ? Math.round((perMemberScores.reduce((a,b)=>a+b,0)/perMemberScores.length)*100)/100 : 0;
            const memberTitle = document.createElement('h4');
            memberTitle.textContent = `Trung b√¨nh ƒëi·ªÉm c√°c nh√≥m (${memberAvg}/${memberMax})`;
            memberSection.appendChild(memberTitle);
            memberSection.appendChild(memberList);
            detailSection.appendChild(memberSection);

            // Section: Visitor
            const visitorSection = document.createElement('div');
            visitorSection.className = 'detail-section';
            const visitors = (await (await fetch('/api/admin/visitors', { cache: 'no-store' })).json()).map(v => v.key);
            const visitorList = document.createElement('ul');
            visitorList.className = 'detail-list';
            const visitorScores = [];
            visitors.forEach(k => {
              const entry = member.detail_score && member.detail_score[k];
              const sc = entry && typeof entry.score === 'number' ? entry.score : 0;
              if (sc > 0) {
                visitorScores.push(sc);
                const li = document.createElement('li');
                li.textContent = `ƒêi·ªÉm ${k} (${sc}/${memberMax})`;
                visitorList.appendChild(li);
                if (entry && entry.criteria && entry.criteria.length) {
                  const sub = document.createElement('ul');
                  sub.className = 'detail-sublist';
                  (memCrit.criteria || []).forEach(c => {
                    const found = entry.criteria.find(x => x.id === c.id);
                    const subLi = document.createElement('li');
                    if (found) {
                      const lvl = inferLevelByScore(found.score, c.maxScore);
                      const label = lvl ? `${lvl.emoji || ''} ${lvl.name}`.trim() : '‚Äî';
                      subLi.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: ${label} (${found.score} ƒëi·ªÉm)`;
                    } else {
                      subLi.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: Ch∆∞a ƒë√°nh gi√°`;
                    }
                    sub.appendChild(subLi);
                  });
                  visitorList.appendChild(sub);
                }
              }
            });
            const visitorAvg = visitorScores.length ? Math.round((visitorScores.reduce((a,b)=>a+b,0)/visitorScores.length)*100)/100 : 0;
            const visitorTitle = document.createElement('h4');
            visitorTitle.textContent = `Trung b√¨nh ƒëi·ªÉm Th·∫ßy/C√¥ (${visitorAvg}/${memberMax})`;
            visitorSection.appendChild(visitorTitle);
            visitorSection.appendChild(visitorList);
            detailSection.appendChild(visitorSection);
          })();
          
          body.appendChild(headerRow);
          body.appendChild(infoSection);
          body.appendChild(actionRow);
          body.appendChild(detailSection);
          app.appendChild(card);
        } catch (err) {
          app.innerHTML = '<div class="card"><div class="card__body"><p style="color: #ef4444;">L·ªói t·∫£i th√¥ng tin: ' + err.message + '</p></div></div>';
        }
      }

      window.renderEvaluationForm = async function renderEvaluationForm() {
        app.innerHTML = '';
        const key = params.get('key') || '';
        const role = params.get('role') || '';
        
        if (!key || !role) {
          app.innerHTML = '<div class="card"><div class="card__body"><p style="color: #ef4444;">Thi·∫øu th√¥ng tin ƒëƒÉng nh·∫≠p</p></div></div>';
          return;
        }

        try {
          const container = document.createElement('div');
          container.className = 'evaluation-container';
          
          const title = document.createElement('h1');
          title.className = 'evaluation-title';
          title.textContent = 'ƒê√°nh gi√°';
          const titleBox = document.createElement('div');
          titleBox.className = 'evaluation-title-box';
          titleBox.appendChild(title);
          container.appendChild(titleBox);

          if (role === 'admin') {
            // Admin ƒë√°nh gi√° 4 member
            const membersRes = await fetch('/api/members?rule=member');
            const members = await membersRes.json();
            
            // Get admin evaluation_key
            const adminRes = await fetch('/api/member/room');
            const admin = await adminRes.json();
            const criteriaRes = await fetch(`/api/criteria/${admin.evaluation_key || 'roomCriteria'}`);
            const criteriaData = await criteriaRes.json();

            for (const member of members) {
              const memberCard = createEvaluationCard(member, criteriaData.criteria, criteriaData.ratingLevels, key, role);
              container.appendChild(memberCard);
            }
          } else if (role === 'member') {
            // Member ƒë√°nh gi√° 3 nh√≥m c√≤n l·∫°i
            const membersRes = await fetch('/api/members?rule=member');
            const allMembers = await membersRes.json();
            const otherMembers = allMembers.filter(m => m.key !== key);
            
            // Get member evaluation_key
            const currentMemberRes = await fetch(`/api/member/${key}`);
            const currentMember = await currentMemberRes.json();
            const criteriaRes = await fetch(`/api/criteria/${currentMember.evaluation_key || 'memberCriteria'}`);
            const criteriaData = await criteriaRes.json();

            for (const member of otherMembers) {
              const memberCard = createEvaluationCard(member, criteriaData.criteria, criteriaData.ratingLevels, key, role);
              container.appendChild(memberCard);
            }
          } else if (role === 'visitor') {
            // Visitor ƒë√°nh gi√° 4 nh√≥m
            const membersRes = await fetch('/api/members?rule=member');
            const members = await membersRes.json();
            
            // Visitor d√πng roomCriteria
            const criteriaRes = await fetch('/api/criteria/roomCriteria');
            const criteriaData = await criteriaRes.json();

            for (const member of members) {
              const memberCard = createEvaluationCard(member, criteriaData.criteria, criteriaData.ratingLevels, key, role);
              container.appendChild(memberCard);
            }
          }

          // N√∫t Ho√†n th√†nh (ch·ªâ admin hi·ªÉn th·ªã)
          if (role === 'admin') {
            const finishBtn = document.createElement('button');
            finishBtn.className = 'button button-action button-evaluate';
            finishBtn.textContent = 'Ho√†n th√†nh ƒë√°nh gi√°';
            finishBtn.addEventListener('click', async () => {
              if (!confirm('X√°c nh·∫≠n ho√†n th√†nh ƒë√°nh gi√° v√† t√≠nh ƒëi·ªÉm cu·ªëi c√πng?')) return;
              try {
                const res = await fetch('/api/evaluate/finalize', { method: 'POST' });
                const data = await res.json();
                if (!res.ok) {
                  alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ ho√†n th√†nh ƒë√°nh gi√°'));
                  return;
                }
                alert('ƒê√£ t√≠nh ƒëi·ªÉm th√†nh c√¥ng!');
                window.isEvaluationMode = false;
                window.location.reload();
              } catch (err) {
                alert('C√≥ l·ªói x·∫£y ra: ' + err.message);
              }
            });
            container.appendChild(finishBtn);
          }

          app.appendChild(container);
        } catch (err) {
          app.innerHTML = '<div class="card"><div class="card__body"><p style="color: #ef4444;">L·ªói: ' + err.message + '</p></div></div>';
        }
      }

      function createEvaluationCard(member, criteria, ratingLevels, evaluatorKey, evaluatorRole) {
        const card = document.createElement('div');
        card.className = 'card evaluation-card';
        
        const body = document.createElement('div');
        body.className = 'card__body';
        
        // Title: member key + name
        const evalHeader = document.createElement('div');
        evalHeader.className = 'evaluation-card-title';
        evalHeader.textContent = `${member.key.toUpperCase()} - ${member.name || 'Ch∆∞a c√≥ t√™n'}`;
        body.appendChild(evalHeader);
        
        const form = document.createElement('form');
        form.className = 'evaluation-form';
        
        const scores = {};
        let totalMaxScore = 0;
        
        // Function to calculate score from level
        function getScoreFromLevel(level, maxScore) {
          // Level 4 = 100%, Level 3 = 75%, Level 2 = 50%, Level 1 = 25%
          const percentage = [0, 0.25, 0.5, 0.75, 1.0];
          return Math.round(maxScore * percentage[level] * 100) / 100;
        }
        
        criteria.forEach(criterion => {
          totalMaxScore += criterion.maxScore;
          
          const row = document.createElement('div');
          row.className = 'evaluation-row';
          
          const header = document.createElement('div');
          header.className = 'evaluation-header';
          
          const title = document.createElement('div');
          title.className = 'evaluation-title-row';
          const titleText = document.createElement('span');
          titleText.className = 'evaluation-criterion-title';
          titleText.textContent = criterion.name;
          const maxScoreText = document.createElement('span');
          maxScoreText.className = 'evaluation-max-score';
          maxScoreText.textContent = `T·ªëi ƒëa: ${criterion.maxScore} ƒëi·ªÉm`;
          title.appendChild(titleText);
          title.appendChild(maxScoreText);
          header.appendChild(title);
          
          const options = document.createElement('div');
          options.className = 'evaluation-options';
          
          const selectedState = document.createElement('div');
          selectedState.className = 'evaluation-selected-state';
          selectedState.textContent = 'Ch∆∞a ch·ªçn';
          selectedState.id = `state-${criterion.id}`;
          
          // Sort rating levels in descending order (4, 3, 2, 1)
          const sortedLevels = [...ratingLevels].sort((a, b) => b.id - a.id);
          
          sortedLevels.forEach(level => {
            const label = document.createElement('label');
            label.className = 'evaluation-radio-option';
            
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = `criterion-${criterion.id}`;
            input.value = level.id;
            input.dataset.criterionId = criterion.id;
            input.dataset.maxScore = criterion.maxScore;
            input.dataset.levelId = level.id;
            
            input.addEventListener('change', () => {
              const score = getScoreFromLevel(level.id, criterion.maxScore);
              scores[criterion.id] = { id: criterion.id, score: score, levelId: level.id };
              selectedState.textContent = `${score} ƒëi·ªÉm`;
              selectedState.style.color = '#3b82f6';
              
              // Update active state
              options.querySelectorAll('.evaluation-radio-option').forEach(opt => {
                opt.classList.remove('active');
              });
              label.classList.add('active');
              
              updateTotalScore();
            });
            
            const emoji = document.createElement('span');
            emoji.className = 'evaluation-emoji';
            emoji.textContent = level.emoji;
            
            const text = document.createElement('span');
            text.className = 'evaluation-option-text';
            text.textContent = level.name;
            
            label.appendChild(input);
            label.appendChild(emoji);
            label.appendChild(text);
            options.appendChild(label);
          });
          
          row.appendChild(header);
          row.appendChild(options);
          row.appendChild(selectedState);
          form.appendChild(row);
        });

        // Total score display
        const totalScoreRow = document.createElement('div');
        totalScoreRow.className = 'evaluation-total-score';
        const totalScoreText = document.createElement('span');
        totalScoreText.className = 'evaluation-total-text';
        totalScoreText.textContent = 'T·ªïng ƒëi·ªÉm ƒë√°nh gi√°: ';
        const totalScoreValue = document.createElement('span');
        totalScoreValue.className = 'evaluation-total-value';
        totalScoreValue.textContent = '0';
        const totalScoreMax = document.createElement('span');
        totalScoreMax.className = 'evaluation-total-max';
        totalScoreMax.textContent = ` / ${totalMaxScore}`;
        totalScoreRow.appendChild(totalScoreText);
        totalScoreRow.appendChild(totalScoreValue);
        totalScoreRow.appendChild(totalScoreMax);
        form.appendChild(totalScoreRow);
        
        function updateTotalScore() {
          let total = 0;
          Object.values(scores).forEach(scoreData => {
            total += scoreData.score || 0;
          });
          totalScoreValue.textContent = Math.round(total * 100) / 100;
        }

        const submitBtn = document.createElement('button');
        submitBtn.type = 'submit';
        submitBtn.className = 'button evaluation-submit-btn';
        submitBtn.textContent = 'L∆∞u ƒë√°nh gi√°';
        
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          // Validate all criteria are selected
          if (Object.keys(scores).length !== criteria.length) {
            alert('Vui l√≤ng ƒë√°nh gi√° t·∫•t c·∫£ c√°c ti√™u ch√≠');
            return;
          }
          
          const scoreData = Object.values(scores).map(s => ({
            id: s.id,
            score: s.score
          }));
          
          try {
            const res = await fetch('/api/evaluate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                evaluatorKey,
                evaluatorRole,
                targetKey: member.key,
                scores: scoreData
              })
            });
            const data = await res.json();
            if (!res.ok) {
              alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ l∆∞u ƒë√°nh gi√°'));
              return;
            }
            alert('ƒê√£ l∆∞u ƒë√°nh gi√° cho ' + member.key.toUpperCase());
            submitBtn.disabled = true;
            submitBtn.textContent = 'ƒê√£ l∆∞u ‚úì';
            submitBtn.style.background = '#22c55e';
          } catch (err) {
            alert('C√≥ l·ªói x·∫£y ra: ' + err.message);
          }
        });
        
        form.appendChild(submitBtn);
        body.appendChild(form);
        card.appendChild(body);
        
        return card;
      }

      async function renderAdminDashboard() {
        const container = document.createElement('div');
        container.className = 'admin-dashboard';
        
        const titleBox = document.createElement('div');
        titleBox.className = 'dashboard-title-box';
        const title = document.createElement('h1');
        title.className = 'dashboard-title';
        title.textContent = 'L·ªõp 6/13';
        titleBox.appendChild(title);
        container.appendChild(titleBox);

        const grid = document.createElement('div');
        grid.className = 'dashboard-grid';

        // Block tr√°i: Danh s√°ch members
        const leftBlock = document.createElement('div');
        leftBlock.className = 'dashboard-block';
        const leftTitle = document.createElement('h2');
        leftTitle.textContent = 'Danh s√°ch nh√≥m';
        leftBlock.appendChild(leftTitle);
        const membersList = document.createElement('div');
        membersList.className = 'members-list';
        leftBlock.appendChild(membersList);
        grid.appendChild(leftBlock);

        // Block ph·∫£i: Danh s√°ch visitors online
        const rightBlock = document.createElement('div');
        rightBlock.className = 'dashboard-block';
        const rightTitle = document.createElement('h2');
        rightTitle.textContent = 'Th·∫ßy/C√¥ ƒëang online';
        rightBlock.appendChild(rightTitle);
        const visitorsList = document.createElement('div');
        visitorsList.className = 'visitors-list';
        rightBlock.appendChild(visitorsList);
        grid.appendChild(rightBlock);

        container.appendChild(grid);

        // Block d∆∞·ªõi c√πng: Action buttons
        const actionBlock = document.createElement('div');
        actionBlock.className = 'dashboard-actions';
        
        const evaluateBtn = document.createElement('button');
        evaluateBtn.className = 'button button-action button-evaluate';
        const evaluateIcon = document.createElement('span');
        evaluateIcon.className = 'button-icon';
        evaluateIcon.innerHTML = '‚≠ê';
        const evaluateText = document.createElement('span');
        evaluateText.textContent = 'ƒê√°nh gi√°';
        evaluateBtn.appendChild(evaluateIcon);
        evaluateBtn.appendChild(evaluateText);
        evaluateBtn.addEventListener('click', () => {
          if (window.socket && typeof window.socket.emit === 'function') {
            window.socket.emit('start_evaluation');
          } else {
            alert('Vui l√≤ng ƒë·ª£i k·∫øt n·ªëi Socket.IO');
          }
        });
        
        const refreshBtn = document.createElement('button');
        refreshBtn.className = 'button button-action button-refresh';
        const refreshIcon = document.createElement('span');
        refreshIcon.className = 'button-icon';
        refreshIcon.innerHTML = 'üîÑ';
        const refreshText = document.createElement('span');
        refreshText.textContent = 'L√†m m·ªõi';
        refreshBtn.appendChild(refreshIcon);
        refreshBtn.appendChild(refreshText);
        refreshBtn.addEventListener('click', async () => {
          const confirmed = confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° to√†n b·ªô d·ªØ li·ªáu? D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c backup.\n\nNh·∫•n OK ƒë·ªÉ ti·∫øp t·ª•c, Cancel ƒë·ªÉ h·ªßy.');
          if (!confirmed) return;

          try {
            const res = await fetch('/api/admin/reset', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (!res.ok) {
              alert('L·ªói: ' + (data.error || 'L√†m m·ªõi th·∫•t b·∫°i'));
              return;
            }
            alert('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu th√†nh c√¥ng!\nFile backup: ' + data.backupFile);
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi
            window.location.reload();
          } catch (err) {
            alert('C√≥ l·ªói x·∫£y ra: ' + err.message);
          }
        });
        
        actionBlock.appendChild(evaluateBtn);
        actionBlock.appendChild(refreshBtn);
        container.appendChild(actionBlock);

        app.appendChild(container);

        // Load v√† render data
        await loadAndRenderMembers(membersList);
        await loadAndRenderVisitors(visitorsList);

        // Listen for status changes
        if (window.socket && typeof window.socket.on === 'function') {
          window.socket.on('member_status_change', async () => {
            await loadAndRenderMembers(membersList);
            await loadAndRenderVisitors(visitorsList);
          });
        }

        // Auto refresh every 3 seconds
        setInterval(async () => {
          await loadAndRenderMembers(membersList);
          await loadAndRenderVisitors(visitorsList);
        }, 3000);
      }

      async function loadAndRenderMembers(container) {
        try {
          const res = await fetch('/api/admin/members', { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to load members');
          const members = await res.json();
          container.innerHTML = '';
          members.forEach(m => {
            const item = document.createElement('div');
            item.className = 'member-item';
            const statusDot = document.createElement('span');
            statusDot.className = `member-dot status-dot ${m.isOnline ? 'online' : 'offline'}`;
            statusDot.title = m.isOnline ? 'ƒêang online' : 'ƒê√£ offline';
            const info = document.createElement('div');
            info.className = 'member-info';
            const keyName = document.createElement('div');
            keyName.className = 'member-key-name';
            keyName.textContent = `${m.key.toUpperCase()} - ${m.name || 'Ch∆∞a c√≥ t√™n'}`;
            const score = document.createElement('div');
            score.className = 'member-score';
            score.textContent = `ƒêi·ªÉm: ${m.score || 0}`;
            info.appendChild(keyName);
            info.appendChild(score);
            const detailBtn = document.createElement('button');
            detailBtn.className = 'button button-small';
            detailBtn.textContent = 'Xem chi ti·∫øt';
            detailBtn.addEventListener('click', () => {
              openMemberDetailPopup(m.key);
            });
            item.appendChild(statusDot);
            item.appendChild(info);
            item.appendChild(detailBtn);
            container.appendChild(item);
          });
        } catch (err) {
          container.innerHTML = '<p style="color: #ef4444;">L·ªói t·∫£i danh s√°ch nh√≥m</p>';
        }
      }

      async function loadAndRenderVisitors(container) {
        try {
          const res = await fetch('/api/admin/visitors', { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to load visitors');
          const visitors = await res.json();
          container.innerHTML = '';
          if (visitors.length === 0) {
            container.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">Ch∆∞a c√≥ Th·∫ßy/C√¥ n√†o ƒëang online</p>';
            return;
          }
          visitors.forEach(v => {
            const item = document.createElement('div');
            item.className = 'visitor-item';
            const keyName = document.createElement('div');
            keyName.className = 'visitor-key-name';
            keyName.textContent = `Th·∫ßy/c√¥: ${v.name || 'Ch∆∞a c√≥ t√™n'}`;
            const evaluated = document.createElement('div');
            evaluated.className = 'visitor-evaluated';
            evaluated.textContent = v.hasEvaluated ? 'ƒê√£ ƒë√°nh gi√°' : 'Ch∆∞a ƒë√°nh gi√°';
            evaluated.style.color = v.hasEvaluated ? '#22c55e' : '#f59e0b';
            item.appendChild(keyName);
            item.appendChild(evaluated);
            container.appendChild(item);
          });
        } catch (err) {
          container.innerHTML = '<p style="color: #ef4444;">L·ªói t·∫£i danh s√°ch Th·∫ßy/C√¥</p>';
        }
      }

      if (!params.has('key')) {
        renderForm();
      } else {
        renderSummary();
      }
    })();

    // Modal detail for member breakdown
    async function openMemberDetailPopup(memberKey) {
      try {
        const [memberRes, roomCritRes, memberCritRes] = await Promise.all([
          fetch(`/api/member/${memberKey}`, { cache: 'no-store' }),
          fetch('/api/criteria/roomCriteria', { cache: 'no-store' }),
          fetch('/api/criteria/memberCriteria', { cache: 'no-store' })
        ]);
        if (!memberRes.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu nh√≥m');
        const member = await memberRes.json();
        const roomCrit = await roomCritRes.json();
        const memCrit = await memberCritRes.json();

        const ratingLevels = (roomCrit.ratingLevels && roomCrit.ratingLevels.length)
          ? roomCrit.ratingLevels
          : (memCrit.ratingLevels || []);

        function sumMaxScore(criteria) {
          return (criteria || []).reduce((s, c) => s + (c.maxScore || 0), 0);
        }

        function getExpectedScoreForLevel(levelId, maxScore) {
          const percentage = [0, 0.25, 0.5, 0.75, 1.0];
          return Math.round(maxScore * percentage[levelId] * 100) / 100;
        }

        function inferLevelByScore(score, maxScore) {
          if (!maxScore || score <= 0) return null;
          let best = { level: null, diff: Infinity };
          ratingLevels.forEach(lvl => {
            const expected = getExpectedScoreForLevel(lvl.id, maxScore);
            const diff = Math.abs((score || 0) - expected);
            if (diff < best.diff) best = { level: lvl, diff };
          });
          return best.level;
        }

        // Build modal
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        const modal = document.createElement('div');
        modal.className = 'modal';
        const header = document.createElement('div');
        header.className = 'modal-header';
        const title = document.createElement('h3');
        title.className = 'modal-title';
        title.textContent = `${member.key.toUpperCase()} - ${member.name || 'Ch∆∞a c√≥ t√™n'}`;
        const closeBtn = document.createElement('button');
        closeBtn.className = 'button button-small modal-close';
        closeBtn.textContent = 'ƒê√≥ng';
        closeBtn.addEventListener('click', () => document.body.removeChild(overlay));
        header.appendChild(title);
        header.appendChild(closeBtn);

        const content = document.createElement('div');
        content.className = 'modal-content';

        // Total current score
        const totalBox = document.createElement('div');
        totalBox.className = 'detail-total-box';
        totalBox.innerHTML = `<strong>T·ªïng ƒëi·ªÉm hi·ªán c√≥:</strong> <span class="detail-total-score">${member.score || 0}</span>`;
        content.appendChild(totalBox);

        // Section: ƒêi·ªÉm ch·ªß ph√≤ng
        const adminSection = document.createElement('div');
        adminSection.className = 'detail-section';
        const adminTitle = document.createElement('h4');
        const roomMax = sumMaxScore(roomCrit.criteria);
        const roomScore = (member.detail_score && member.detail_score.room && member.detail_score.room.score) || 0;
        adminTitle.textContent = `ƒêi·ªÉm ch·ªß ph√≤ng (${roomScore}/${roomMax})`;
        adminSection.appendChild(adminTitle);
        const adminList = document.createElement('ul');
        adminList.className = 'detail-list';
        (roomCrit.criteria || []).forEach(c => {
          const li = document.createElement('li');
          const item = (member.detail_score && member.detail_score.room && member.detail_score.room.criteria || []).find(x => x.id === c.id);
          if (item) {
            const lvl = inferLevelByScore(item.score, c.maxScore);
            const label = lvl ? `${lvl.emoji || ''} ${lvl.name}`.trim() : '‚Äî';
            li.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: ${label} (${item.score} ƒëi·ªÉm)`;
          } else {
            li.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: Ch∆∞a ƒë√°nh gi√°`;
          }
          adminList.appendChild(li);
        });
        adminSection.appendChild(adminList);
        content.appendChild(adminSection);

        // Section: Avg ƒëi·ªÉm c√°c nh√≥m
        const memberSection = document.createElement('div');
        memberSection.className = 'detail-section';
        const memberMax = sumMaxScore(memCrit.criteria);
        const otherMembers = (await (await fetch('/api/admin/members', { cache: 'no-store' })).json()).map(m => m.key).filter(k => k !== member.key);
        const perMemberScores = [];
        const memberList = document.createElement('ul');
        memberList.className = 'detail-list';
        otherMembers.forEach(k => {
          const entry = member.detail_score && member.detail_score[k];
          const sc = entry && typeof entry.score === 'number' ? entry.score : 0;
          perMemberScores.push(sc);
          const li = document.createElement('li');
          li.textContent = `ƒêi·ªÉm ${k.toUpperCase()} (${sc}/${memberMax})`;
          memberList.appendChild(li);
          // criteria breakdown under each
          if (entry && entry.criteria && entry.criteria.length) {
            const sub = document.createElement('ul');
            sub.className = 'detail-sublist';
            (memCrit.criteria || []).forEach(c => {
              const found = entry.criteria.find(x => x.id === c.id);
              const subLi = document.createElement('li');
              if (found) {
                const lvl = inferLevelByScore(found.score, c.maxScore);
                const label = lvl ? `${lvl.emoji || ''} ${lvl.name}`.trim() : '‚Äî';
                subLi.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: ${label} (${found.score} ƒëi·ªÉm)`;
              } else {
                subLi.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: Ch∆∞a ƒë√°nh gi√°`;
              }
              sub.appendChild(subLi);
            });
            memberList.appendChild(sub);
          }
        });
        const memberAvg = perMemberScores.length ? Math.round((perMemberScores.reduce((a,b)=>a+b,0)/perMemberScores.length)*100)/100 : 0;
        const memberTitle = document.createElement('h4');
        memberTitle.textContent = `Trung b√¨nh ƒëi·ªÉm c√°c nh√≥m (${memberAvg}/${memberMax})`;
        memberSection.appendChild(memberTitle);
        memberSection.appendChild(memberList);
        content.appendChild(memberSection);

        // Section: Visitor
        const visitorSection = document.createElement('div');
        visitorSection.className = 'detail-section';
        const visitors = (await (await fetch('/api/admin/visitors', { cache: 'no-store' })).json()).map(v => v.key);
        const visitorList = document.createElement('ul');
        visitorList.className = 'detail-list';
        const visitorScores = [];
        visitors.forEach(k => {
          const entry = member.detail_score && member.detail_score[k];
          const sc = entry && typeof entry.score === 'number' ? entry.score : 0;
          if (sc > 0) {
            visitorScores.push(sc);
            const li = document.createElement('li');
            li.textContent = `ƒêi·ªÉm ${k} (${sc}/${memberMax})`;
            visitorList.appendChild(li);
            if (entry && entry.criteria && entry.criteria.length) {
              const sub = document.createElement('ul');
              sub.className = 'detail-sublist';
              (memCrit.criteria || []).forEach(c => {
                const found = entry.criteria.find(x => x.id === c.id);
                const subLi = document.createElement('li');
                if (found) {
                  const lvl = inferLevelByScore(found.score, c.maxScore);
                  const label = lvl ? `${lvl.emoji || ''} ${lvl.name}`.trim() : '‚Äî';
                  subLi.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: ${label} (${found.score} ƒëi·ªÉm)`;
                } else {
                  subLi.textContent = `${c.name || ('Ti√™u ch√≠ ' + c.id)}: Ch∆∞a ƒë√°nh gi√°`;
                }
                sub.appendChild(subLi);
              });
              visitorList.appendChild(sub);
            }
          }
        });
        const visitorAvg = visitorScores.length ? Math.round((visitorScores.reduce((a,b)=>a+b,0)/visitorScores.length)*100)/100 : 0;
        const visitorTitle = document.createElement('h4');
        visitorTitle.textContent = `Trung b√¨nh ƒëi·ªÉm Th·∫ßy/C√¥ (${visitorAvg}/${memberMax})`;
        visitorSection.appendChild(visitorTitle);
        visitorSection.appendChild(visitorList);
        content.appendChild(visitorSection);

        modal.appendChild(header);
        modal.appendChild(content);
        overlay.appendChild(modal);
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) document.body.removeChild(overlay);
        });
        document.body.appendChild(overlay);
      } catch (err) {
        alert('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt: ' + err.message);
      }
    }

    // Socket.IO Status Indicator - Ch·ªâ k·∫øt n·ªëi sau khi tham gia
    (function() {
      const statusEl = document.getElementById('socket-status');
      let socket = null;
      const urlParams = new URLSearchParams(window.location.search);

      function updateStatus(text, className) {
        statusEl.textContent = text;
        statusEl.className = 'socket-status ' + className;
      }

      function initSocket() {
        // Ch·ªâ k·∫øt n·ªëi n·∫øu ƒë√£ c√≥ params key (ƒë√£ tham gia)
        if (!urlParams.has('key')) {
          statusEl.style.display = 'none';
          return null;
        }

        statusEl.style.display = 'flex';
        updateStatus('ƒêang k·∫øt n·ªëi', 'connecting');
        
        if (typeof window.io !== 'function') {
          updateStatus('M·∫•t k·∫øt n·ªëi', 'disconnected');
          return null;
        }

        socket = io();

        socket.on('connect', () => {
          updateStatus('ƒê√£ k·∫øt n·ªëi', 'connected');
          // Register v·ªõi server khi connect
          const key = urlParams.get('key');
          if (key) {
            socket.emit('register', { key });
          }
        });

        socket.on('disconnect', (reason) => {
          updateStatus('M·∫•t k·∫øt n·ªëi', 'disconnected');
        });

        socket.on('connect_error', () => {
          updateStatus('M·∫•t k·∫øt n·ªëi', 'disconnected');
        });

        socket.io.on('reconnect_attempt', () => {
          updateStatus('ƒêang k·∫øt n·ªëi', 'connecting');
        });

        socket.io.on('reconnect', () => {
          updateStatus('ƒê√£ k·∫øt n·ªëi', 'connected');
          // Register l·∫°i khi reconnect
          const key = urlParams.get('key');
          if (key) {
            socket.emit('register', { key });
          }
        });

        // Listen for evaluation mode
        socket.on('evaluation_mode_started', () => {
          window.isEvaluationMode = true;
          if (typeof window.renderEvaluationForm === 'function') {
            window.renderEvaluationForm();
          }
        });

        return socket;
      }

      initSocket();
      // Store socket globally ƒë·ªÉ d√πng ·ªü renderAdminDashboard
      window.socket = socket;
    })();
  </script>
</body>
</html>